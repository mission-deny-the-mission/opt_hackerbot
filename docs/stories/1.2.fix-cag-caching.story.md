# Story 1.2: Implement CAG Fix or Simplified Reimplementation

**Epic**: Epic 1 - LLM Feature Stabilization
**Story ID**: 1.2
**Priority**: Critical
**Estimated Effort**: 3-5 days (depends on approach - repair vs reimplement)
**Dependencies**: Story 1.1 (diagnosis complete)

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to fix CAG document loading based on diagnosis findings,
**so that** the CAG system can cache and retrieve knowledge sources.

---

## Acceptance Criteria

1. CAG system successfully loads man pages from knowledge_bases/sources/man_pages/
2. CAG system successfully loads lab sheets (markdown files) from configured sources
3. Cached documents persist in memory for subsequent retrieval
4. CAG manager can retrieve cached content without reloading
5. Implementation approach documented (knowledge graph retained, simplified, or replaced)
6. Error handling implemented for missing or malformed documents
7. Basic functional testing passes (manual verification of load/retrieve cycle)

---

## Integration Verification

- **IV1**: Verify RAG system functionality unchanged
- **IV2**: Verify bot startup time remains acceptable (<60 seconds with typical knowledge base)
- **IV3**: Verify memory usage stays within bounds (NFR2: <4GB)

---

## Tasks / Subtasks

### ⚠️ CRITICAL: Implementation Approach Decision

**This story's tasks depend on Story 1.1 findings. Select ONE approach based on diagnosis:**

---

### APPROACH A: Repair Existing Knowledge Graph Implementation

**Use if Story 1.1 recommends**: Fixing existing in_memory_graph_client.rb

- [ ] **Task A.1: Fix Identified Bugs in Graph Client** (AC: 1, 2, 3, 4)
  - [ ] Address each issue identified in Story 1.1 root cause analysis
  - [ ] Fix node creation bugs (if any)
  - [ ] Fix relationship creation bugs (if any)
  - [ ] Fix index maintenance issues (if any)
  - [ ] Fix search/retrieval bugs (if any)
  - [ ] Add missing error handling for edge cases

- [ ] **Task A.2: Fix CAG Manager Integration** (AC: 1, 2, 4)
  - [ ] Fix `add_knowledge_triplet` method if broken
  - [ ] Fix `create_knowledge_base_from_triplets` method
  - [ ] Ensure proper error propagation from graph client
  - [ ] Add retry logic for transient failures
  - [ ] Improve logging for debugging

- [ ] **Task A.3: Fix Knowledge Source Loading** (AC: 1, 2)
  - [ ] Fix man page triplet generation in man_page_processor.rb (if broken)
  - [ ] Fix markdown/lab sheet loading (if broken)
  - [ ] Ensure knowledge sources call CAG manager correctly
  - [ ] Validate triplet format matches graph client expectations

- [ ] **Task A.4: Add Comprehensive Error Handling** (AC: 6)
  - [ ] Graceful handling of missing man pages
  - [ ] Graceful handling of malformed knowledge sources
  - [ ] Clear error messages using Print.err
  - [ ] Prevent crashes on bad input
  - [ ] Document error scenarios

---

### APPROACH B: Simplified CAG Reimplementation

**Use if Story 1.1 recommends**: Replacing knowledge graph with simpler caching

- [ ] **Task B.1: Design Simplified Cache Structure** (AC: 3, 4, 5)
  - [ ] Design simple hash-based cache (knowledge_id => content)
  - [ ] OR design pre-cached prompt approach
  - [ ] OR design file-based cache approach
  - [ ] Document design decision and rationale
  - [ ] Ensure design supports offline operation
  - [ ] Estimate memory requirements

- [ ] **Task B.2: Implement New Cache Manager** (AC: 1, 2, 3, 4)
  - [ ] Create new simplified_cag_manager.rb (or rename existing)
  - [ ] Implement `load_documents(source, docs)` method
  - [ ] Implement `cache_document(id, content)` method
  - [ ] Implement `retrieve_document(id)` method
  - [ ] Implement `search_cache(query)` method
  - [ ] Add memory usage tracking

- [ ] **Task B.3: Update Knowledge Source Integration** (AC: 1, 2)
  - [ ] Modify man_page_knowledge.rb to work with new cache format
  - [ ] Modify markdown_knowledge.rb for lab sheets
  - [ ] Simplify triplet generation (if no longer needed)
  - [ ] Test loading man pages into new cache
  - [ ] Test loading lab sheets into new cache

- [ ] **Task B.4: Update RAG/CAG Manager Integration** (AC: 4)
  - [ ] Update rag_cag_manager.rb to use new cache interface
  - [ ] Ensure backwards compatibility with RAG
  - [ ] Test combined RAG+CAG operation
  - [ ] Test CAG-only operation

- [ ] **Task B.5: Add Error Handling** (AC: 6)
  - [ ] Handle missing documents gracefully
  - [ ] Handle malformed content gracefully
  - [ ] Clear error messages using Print.err
  - [ ] Document error scenarios

- [ ] **Task B.6: Deprecate Old Graph Client** (AC: 5)
  - [ ] Mark old files as deprecated (comments)
  - [ ] Update architecture docs with new approach
  - [ ] Document migration from graph to simplified cache
  - [ ] Keep old files temporarily for reference

---

### APPROACH C: Minimal Fixes + RAG-Only Fallback

**Use if Story 1.1 recommends**: CAG too complex, proceed RAG-only

- [ ] **Task C.1: Document CAG Issues** (AC: 5)
  - [ ] Create docs/cag-postponed.md with full issue analysis
  - [ ] Document why reimplementation deferred
  - [ ] Document what would be required to fix properly
  - [ ] Recommend future work scope

- [ ] **Task C.2: Disable CAG Gracefully** (AC: 6)
  - [ ] Ensure CAG failures don't crash system
  - [ ] Log clear messages when CAG disabled
  - [ ] Update bot configs to default CAG off
  - [ ] Ensure RAG-only mode fully functional

- [ ] **Task C.3: Update Documentation** (AC: 5)
  - [ ] Update PRD noting RAG-only decision
  - [ ] Update architecture docs
  - [ ] Note CAG as future work
  - [ ] Document RAG as primary path forward

---

### Common Tasks (All Approaches)

- [ ] **Task 9: Manual Functional Testing** (AC: 7)
  - [ ] Test loading specific man pages (ls, grep, netstat, ssh, iptables)
  - [ ] Test loading lab sheet markdown files
  - [ ] Test cache retrieval without reload
  - [ ] Test querying cached content
  - [ ] Verify content accuracy
  - [ ] Test edge cases (empty docs, huge docs, missing docs)

- [ ] **Task 10: Integration Verification** (IV1, IV2, IV3)
  - [ ] **IV1**: Run existing RAG tests, verify no regressions
  - [ ] **IV2**: Measure bot startup time with knowledge base loaded
  - [ ] **IV3**: Monitor memory usage during operation
  - [ ] Test bot with CAG enabled in XML config
  - [ ] Test bot with CAG disabled in XML config
  - [ ] Verify existing bot functionality intact

- [ ] **Task 11: Documentation** (AC: 5)
  - [ ] Document chosen implementation approach
  - [ ] Update inline code comments
  - [ ] Update RAG_CAG_IMPLEMENTATION_SUMMARY.md
  - [ ] Document any breaking changes (if any)
  - [ ] Document testing performed

---

## Dev Notes

### Previous Story Insights

**From Story 1.1**:
- Root cause analysis document located at docs/stories/root_cause_analysis.md
- Recommended approach: [REPAIR / REIMPLEMENT / FALLBACK]
- Time estimate for approach: [X days]
- Key failure points identified: [List from Story 1.1]
- Critical files needing changes: [List from Story 1.1]

**Implementation Decision**: Based on Story 1.1 recommendation, select Approach A, B, or C above.

### CAG System Context

**Current Implementation Files**:
- `cag/cag_manager.rb` - Main coordinator (may need fixes or replacement)
- `cag/in_memory_graph_client.rb` - Current graph implementation (may need fixes or replacement)
- `cag/knowledge_graph_interface.rb` - Abstract interface (keep if using graph)
- `knowledge_bases/sources/man_pages/man_page_knowledge.rb` - Man page loader
- `knowledge_bases/utils/man_page_processor.rb` - Man page parsing

[Source: Story 1.1 Dev Notes]

### Integration Points

**RAG/CAG Manager** (`rag_cag_manager.rb`):
```ruby
class RAGCAGManager
  def initialize(rag_config, cag_config, unified_config)
    @cag_manager = CAGManager.new(cag_config)
    # ...
  end

  def get_enhanced_context(query, options = {})
    cag_context = @cag_manager.get_contextual_entities(query) if @config[:enable_cag]
    # Must handle CAG failures gracefully
  end
end
```
[Source: docs/development/architecture.md#215-243]

**Knowledge Source Interface Pattern**:
```ruby
class ManPageKnowledgeSource < BaseKnowledgeSource
  def get_cag_triplets(collection_name = nil)
    # Returns array of triplets: { subject:, relationship:, object: }
  end
end
```
[Source: Codebase inspection]

### Simplified Cache Design Example

**If implementing Approach B**, consider this structure:

```ruby
class SimplifiedCAGManager
  def initialize(config)
    @cache = {}  # Hash: doc_id => { content:, metadata: }
    @index = {}  # Hash: keyword => [doc_ids]
  end

  def cache_document(id, content, metadata = {})
    @cache[id] = { content: content, metadata: metadata }
    index_document(id, content)
  end

  def retrieve_document(id)
    @cache[id]
  end

  def search_cache(query)
    # Simple keyword matching in indexed terms
  end
end
```

### Performance Constraints

**Must Meet**:
- Memory usage ≤ 4GB for 1000+ documents (NFR2)
- Cache loading time ≤ 60 seconds (NFR3)
- Bot startup time ≤ 60 seconds total
- Query response ≤ 5 seconds excluding LLM (NFR4)

[Source: docs/prd.md#2.2 Non-Functional Requirements]

### Error Handling Pattern

```ruby
begin
  # CAG operation
rescue => e
  Print.err "CAG operation failed: #{e.message}"
  Print.err e.backtrace.inspect
  return nil  # Graceful degradation
end
```
[Source: docs/prd.md#3.3 Coding Standards]

### Offline-First Principle

**CRITICAL**: No external API calls allowed in CAG
- All data must be loadable from local files
- No network dependencies
- Must work in air-gapped environments

[Source: docs/prd.md#1.5 Goals and Background Context]

### Testing Standards

**Manual Testing Required** (no automated tests yet):
- Test with real man pages from system
- Test with sample lab sheet markdown files
- Test memory usage with large knowledge bases
- Test startup time impact
- Test retrieval accuracy

**Test Data Locations**:
- Man pages: System man pages (e.g., /usr/share/man/)
- Lab sheets: knowledge_bases/ directory or config/

---

## Testing

### Testing Strategy for This Story

**1. Unit-Level Testing**:
- Test individual methods in isolation
- Test error handling paths
- Test edge cases (empty, null, malformed data)

**2. Integration Testing**:
- Test CAG + RAG together via rag_cag_manager
- Test knowledge source loading end-to-end
- Test bot initialization with CAG enabled

**3. Performance Testing**:
- Measure cache loading time
- Monitor memory usage
- Check bot startup time impact

**4. Regression Testing**:
- Verify RAG system still works
- Verify bot functionality unchanged
- Check existing configs still valid

### Manual Test Scenarios

1. **Load Man Pages**:
   ```bash
   # Start bot with CAG enabled
   ruby hackerbot.rb --enable-rag-cag
   # Verify man pages loaded without errors
   # Check logs for success messages
   ```

2. **Cache Retrieval**:
   - Query for man page content (e.g., "What does ls command do?")
   - Verify content retrieved from cache
   - Repeat query, ensure no reload

3. **Error Scenarios**:
   - Try loading non-existent man page
   - Try loading malformed markdown file
   - Verify graceful error handling

4. **Memory Check**:
   - Load typical knowledge base (~100-500 documents)
   - Monitor process memory usage
   - Verify stays under 4GB limit

### Test File Location

No automated tests for this story. Comprehensive test suite in Story 1.4.

[Source: docs/prd.md#3.2 Integration Approach - Testing Integration Strategy]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | v1.0 | Initial story creation | SM Agent (Bob) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_This section will be populated by QA Agent after story completion._

---

**Story prepared by**: Scrum Master Agent (Bob)
**Ready for**: Developer Agent implementation (after Story 1.1 complete)
**Next Story**: 1.3 - Create Comprehensive RAG Test Suite (can proceed in parallel)

**⚠️ TIME-BOX WARNING**: This story is time-boxed to 1 week maximum. If work extends beyond 1 week, trigger RAG-only fallback decision point.
