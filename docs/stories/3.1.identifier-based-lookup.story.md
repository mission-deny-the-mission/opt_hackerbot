# Story 3.1: Add Identifier-Based Lookup to Knowledge Sources

**Epic**: Epic 3 - Stage-Aware Context Injection
**Story ID**: 3.1
**Priority**: Critical
**Estimated Effort**: 3-4 days
**Dependencies**: None (Epic 1 completion recommended)

---

## Status

**Ready for Review**

---

## Story

**As a** bot trainer,
**I want** to retrieve specific knowledge items by identifier (man page name, document path, MITRE technique ID),
**so that** I can explicitly include targeted knowledge in attack stages without relying solely on similarity search.

---

## Acceptance Criteria

1. `ManPageKnowledgeSource` supports `get_man_page_by_name(command_name)` method that retrieves a specific man page by command name (e.g., "nmap", "netcat")
2. `MarkdownKnowledgeSource` supports `get_document_by_path(file_path)` method that retrieves a specific document by file path (e.g., "attack-guide.md", "docs/pentest-primer.md")
3. `MITREAttackKnowledge` supports `get_technique_by_id(technique_id)` method that retrieves a specific MITRE technique by ID (e.g., "T1003", "T1059.001")
4. Methods return structured data compatible with existing RAG document format
5. Methods handle not found cases gracefully (return nil or empty result, log warning)
6. Unit tests verify lookup functionality for all three knowledge source types
7. Methods support optional section parameter for man pages (get_man_page_by_name accepts optional section:)
8. Returned documents include proper metadata (source attribution, type, identifier)

---

## Integration Verification

- **IV1**: Verify lookup methods don't interfere with existing knowledge source loading workflows
- **IV2**: Verify lookup performance is acceptable (direct access, no full knowledge base scan)
- **IV3**: Verify methods work with both loaded and unloaded knowledge sources (lazy loading support)

---

## Tasks / Subtasks

### Phase 1: Man Page Lookup Implementation (AC: 1, 7, 8)

- [x] **Task 1.1: Add `get_man_page_by_name` method to ManPageKnowledgeSource**
  - [x] Add public method `get_man_page_by_name(command_name, section: nil)` to `knowledge_bases/sources/man_pages/man_page_knowledge.rb`
  - [x] Method should use existing `@processor.man_page_exists?` to validate
  - [x] Use existing `@processor.get_man_page(man_name, section)` for retrieval
  - [x] Convert result to RAG document format using existing `@processor.to_rag_document` helper
  - [x] Return hash with structure: `{ rag_document: {...}, found: true/false }` or `nil` if not found
  - [x] Include metadata: `{ source_type: 'man_page', command_name: command_name, section: section, source: "man page '#{command_name}'" }`
  - [x] Handle error cases (man page not found, processing errors)
  - [x] Log warning if man page not found (use Print.warn)

- [x] **Task 1.2: Ensure Man Page Lookup Works with Existing Collections**
  - [x] Verify method can retrieve from already-loaded collections if man page was previously loaded
  - [x] Verify method can load man page on-demand if not in collections (lazy loading)
  - [x] Ensure returned format matches documents from `get_rag_documents` for consistency

### Phase 2: Markdown Document Lookup Implementation (AC: 2, 8)

- [x] **Task 2.1: Add `get_document_by_path` method to MarkdownKnowledgeSource**
  - [x] Add public method `get_document_by_path(file_path)` to `knowledge_bases/sources/markdown_files/markdown_knowledge.rb`
  - [x] Use existing `@processor.markdown_file_exists?` to validate file exists
  - [x] Use existing `@processor.to_rag_document(file_path)` for retrieval
  - [x] Return hash with structure: `{ rag_document: {...}, found: true/false }` or `nil` if not found
  - [x] Normalize file path using `File.expand_path` for consistent lookup
  - [x] Include metadata: `{ source_type: 'markdown', file_path: normalized_path, source: "document '#{File.basename(file_path)}'" }`
  - [x] Handle error cases (file not found, parsing errors)
  - [x] Log warning if document not found (use Print.warn)

- [x] **Task 2.2: Ensure Markdown Lookup Works with Existing Collections**
  - [x] Verify method can retrieve from already-loaded collections if document was previously loaded
  - [x] Verify method can load document on-demand if not in collections (lazy loading)
  - [x] Ensure returned format matches documents from `get_rag_documents` for consistency

### Phase 3: MITRE ATT&CK Technique Lookup Implementation (AC: 3, 8)

- [x] **Task 3.1: Add `get_technique_by_id` method to MITREAttackKnowledge module**
  - [x] Add module method `self.get_technique_by_id(technique_id)` to `knowledge_bases/mitre_attack_knowledge.rb`
  - [x] Search `ATTACK_PATTERNS` array for matching technique ID (exact match or parent technique match)
  - [x] Support both base technique IDs (e.g., "T1003") and sub-technique IDs (e.g., "T1003.001")
  - [x] Convert MITRE technique data to RAG document format
  - [x] Return hash with structure: `{ rag_document: {...}, found: true/false }` or `nil` if not found
  - [x] RAG document should include technique ID, name, tactic, description, techniques array, related tools, mitigation
  - [x] Include metadata: `{ source_type: 'mitre_attack', technique_id: technique_id, source: "MITRE ATT&CK #{technique_id}" }`
  - [x] Handle error cases (technique ID not found, invalid format)
  - [x] Log warning if technique not found (use Print.warn)

- [x] **Task 3.2: Ensure MITRE Lookup Format Matches Existing RAG Documents**
  - [x] Verify returned document structure matches format from `MITREAttackKnowledge.to_rag_documents`
  - [x] Ensure content is formatted for LLM consumption (readable, structured)

### Phase 4: Unit Testing (AC: 6)

- [x] **Task 4.1: Create Test File for Identifier-Based Lookup**
  - [x] Create `test/test_knowledge_source_lookup.rb`
  - [x] Set up test framework using Minitest (following `test/test_helper.rb` patterns)
  - [x] Create test class: `TestKnowledgeSourceLookup < Minitest::Test`

- [x] **Task 4.2: Test Man Page Lookup**
  - [x] Test `get_man_page_by_name` with existing man page (e.g., "ls")
  - [x] Test `get_man_page_by_name` with non-existent man page (should return nil or hash with found: false)
  - [x] Test `get_man_page_by_name` with optional section parameter
  - [x] Verify returned document has correct structure and metadata
  - [x] Verify error handling and logging

- [x] **Task 4.3: Test Markdown Lookup**
  - [x] Test `get_document_by_path` with existing markdown file
  - [x] Test `get_document_by_path` with non-existent file (should return nil or hash with found: false)
  - [x] Test path normalization (relative vs absolute paths)
  - [x] Verify returned document has correct structure and metadata
  - [x] Verify error handling and logging

- [x] **Task 4.4: Test MITRE ATT&CK Lookup**
  - [x] Test `get_technique_by_id` with existing technique (e.g., "T1003")
  - [x] Test `get_technique_by_id` with sub-technique (e.g., "T1003.001")
  - [x] Test `get_technique_by_id` with non-existent technique (should return nil)
  - [x] Test invalid technique ID format (should handle gracefully)
  - [x] Verify returned document has correct structure and metadata
  - [x] Verify error handling and logging

- [x] **Task 4.5: Integration Tests with Knowledge Source Manager**
  - [x] Test lookup methods work when knowledge sources are managed through `KnowledgeSourceManager`
  - [x] Verify lookup doesn't interfere with existing `get_rag_documents` functionality
  - [x] Test lookup with lazy loading (man page/document not pre-loaded)

### Phase 5: Documentation and Verification (AC: 4, 5)

- [x] **Task 5.1: Verify Return Format Compatibility**
  - [x] Ensure all three lookup methods return documents in format compatible with `rag_documents` array
  - [x] Verify metadata structure matches existing RAG document metadata expectations
  - [x] Test integration with existing RAG system (documents from lookup can be added to vector DB)

- [x] **Task 5.2: Update Code Documentation**
  - [x] Add YARD documentation comments to all three new methods
  - [x] Document parameters, return values, and error cases
  - [x] Add usage examples in comments

---

## Dev Notes

### Previous Story Insights

[No previous stories in Epic 3 - this is the first story]

### Data Models

**RAG Document Format** (from existing codebase analysis):
```ruby
{
  content: String,           # Full text content of the document
  metadata: {
    source: String,          # Source identifier (e.g., "man page 'nmap'", "MITRE ATT&CK T1003")
    source_type: String,     # Type: 'man_page', 'markdown', 'mitre_attack'
    man_name: String,        # For man pages: command name
    file_path: String,       # For markdown: normalized file path
    technique_id: String,     # For MITRE: technique ID (e.g., "T1003")
    section: Integer,        # Optional: man page section (1-8)
    # ... other metadata fields
  }
}
```

**Return Format for Lookup Methods**:
- Success: `{ rag_document: {...}, found: true }` or return RAG document hash directly
- Not Found: `nil` or `{ found: false }` (design decision needed)
- Error: `nil` with logged warning

[Source: analysis of `knowledge_bases/sources/man_pages/man_page_knowledge.rb`, `knowledge_bases/sources/markdown_files/markdown_knowledge.rb`, `knowledge_bases/mitre_attack_knowledge.rb`]

### API Specifications

**ManPageKnowledgeSource Methods**:
- Existing: `add_man_page(man_name, section = nil, collection_name = 'default_man_pages')`
- Existing: `get_man_page_info(man_name, section = nil)`
- Existing: `man_page_exists?(man_name, section = nil)`
- New: `get_man_page_by_name(command_name, section: nil)` → Returns RAG document format

**MarkdownKnowledgeSource Methods**:
- Existing: `add_markdown_file(file_path, collection_name = 'default_markdown_files')`
- Existing: `get_markdown_file_info(file_path)`
- Existing: `markdown_file_exists?(file_path)`
- New: `get_document_by_path(file_path)` → Returns RAG document format

**MITREAttackKnowledge Module Methods**:
- Existing: `self.to_rag_documents` → Returns array of all MITRE techniques
- Existing: `self.to_cag_triplets` → Returns array of knowledge graph triplets
- New: `self.get_technique_by_id(technique_id)` → Returns single RAG document for technique

[Source: code analysis of knowledge source classes]

### File Locations

**Files to Modify**:
- `knowledge_bases/sources/man_pages/man_page_knowledge.rb` - Add `get_man_page_by_name` method
- `knowledge_bases/sources/markdown_files/markdown_knowledge.rb` - Add `get_document_by_path` method
- `knowledge_bases/mitre_attack_knowledge.rb` - Add `self.get_technique_by_id` method

**Files to Create**:
- `test/test_knowledge_source_lookup.rb` - Unit tests for identifier-based lookup

[Source: `docs/architecture/source-tree.md`]

### Testing Requirements

**Test Framework**: Minitest (standard Ruby testing framework used in project)
**Test Location**: `test/test_knowledge_source_lookup.rb`

**Test Patterns** (from existing test files):
```ruby
require 'minitest/autorun'
require_relative 'test_helper'
require_relative '../knowledge_bases/sources/man_pages/man_page_knowledge.rb'
# ... test implementation
```

**Test Requirements**:
- Unit tests for each lookup method (man page, markdown, MITRE)
- Test both success and failure cases
- Verify return format matches RAG document structure
- Verify error handling doesn't crash
- Verify metadata is correctly populated

[Source: `docs/architecture/coding-standards.md`, analysis of existing test files]

### Technical Constraints

**Ruby Version**: 3.1+ (as specified in architecture)
**Dependencies**: 
- Existing knowledge source processors (`ManPageProcessor`, `MarkdownProcessor`)
- Print utilities for logging (`require_relative '../../print.rb'`)

**Performance Considerations**:
- Lookup should be direct (O(1) or O(n) where n is small for MITRE patterns array)
- Avoid full knowledge base scans
- Lazy loading support (load on-demand if not in collections)

**Backward Compatibility**:
- All new methods are additive (no breaking changes)
- Existing methods (`get_rag_documents`, `load_knowledge`) remain unchanged
- Lookup methods don't modify existing collections

[Source: `docs/architecture.md`, code analysis]

### Technical Implementation Details

**Man Page Lookup**:
- Use existing `@processor.get_man_page(man_name, section)` which returns hash with 'content', 'man_name', 'section'
- Convert to RAG format using `@processor.to_rag_document(man_name, section)` which already exists
- Check `man_page_exists?` first to avoid unnecessary processing

**Markdown Lookup**:
- Use existing `@processor.to_rag_document(file_path)` which converts markdown to RAG format
- Normalize paths to handle relative vs absolute paths consistently
- Use `File.expand_path` for normalization

**MITRE ATT&CK Lookup**:
- Search `ATTACK_PATTERNS` array for technique ID match
- Support both base techniques (e.g., "T1003") and sub-techniques (e.g., "T1003.001")
- Format technique data as readable text for LLM consumption
- Include all relevant fields: name, tactic, description, techniques, related_tools, mitigation

[Source: code analysis of `knowledge_bases/sources/man_pages/man_page_knowledge.rb`, `knowledge_bases/sources/markdown_files/markdown_knowledge.rb`, `knowledge_bases/mitre_attack_knowledge.rb`]

### Error Handling

All methods should:
- Return `nil` or `{ found: false }` when item not found (consistent with existing patterns)
- Log warnings using `Print.warn` when item not found
- Handle processing errors gracefully (try/rescue blocks)
- Not raise exceptions for "not found" cases (expected behavior)

[Source: analysis of existing error handling patterns in knowledge source classes]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used

James (dev) - Composer

### Debug Log References

- Implementation of identifier-based lookup methods for three knowledge source types
- All methods return consistent format: `{ rag_document: {...}, found: true }` or `nil` for not found
- Error handling with Print.warn/Print.err logging

### Completion Notes List

1. **Phase 1 Complete**: Added `get_man_page_by_name` method to `ManPageKnowledgeSource`
   - Uses existing processor methods (`man_page_exists?`, `to_rag_document`)
   - Supports optional section parameter
   - Returns RAG document format with enhanced metadata

2. **Phase 2 Complete**: Added `get_document_by_path` method to `MarkdownKnowledgeSource`
   - Normalizes file paths using `File.expand_path`
   - Uses existing processor methods (`markdown_file_exists?`, `to_rag_document`)
   - Returns RAG document format with enhanced metadata

3. **Phase 3 Complete**: Added `get_technique_by_id` module method to `MITREAttackKnowledge`
   - Supports both base techniques (e.g., "T1003") and sub-techniques (e.g., "T1003.001")
   - Searches ATTACK_PATTERNS array for matches
   - Returns formatted document compatible with existing `to_rag_documents` format

4. **Phase 4 Complete**: Created comprehensive test suite
   - Test file: `test/test_knowledge_source_lookup.rb`
   - Tests cover all three lookup methods with success/failure cases
   - Includes integration tests for format compatibility

5. **Phase 5 Complete**: Documentation and verification
   - All methods include YARD documentation comments
   - Return formats verified to match existing RAG document structure
   - Metadata structure matches expectations for vector DB integration

**Note**: All methods support lazy loading - they work whether knowledge sources are pre-loaded or not.

### File List

**Modified Files:**
- `knowledge_bases/sources/man_pages/man_page_knowledge.rb` - Added `get_man_page_by_name` method
- `knowledge_bases/sources/markdown_files/markdown_knowledge.rb` - Added `get_document_by_path` method
- `knowledge_bases/mitre_attack_knowledge.rb` - Added `get_technique_by_id` module method

**New Files:**
- `test/test_knowledge_source_lookup.rb` - Comprehensive unit and integration tests for identifier-based lookup

---

## QA Results

### Review Date: 2025-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: ✅ **EXCELLENT** - Implementation is production-ready with comprehensive test coverage.

The identifier-based lookup methods have been implemented following best practices:
- All three knowledge source types (man pages, markdown, MITRE ATT&CK) support identifier-based lookup
- Methods return consistent format: `{ rag_document: {...}, found: true }` or `nil` for not found cases
- Error handling uses `Print.warn`/`Print.err` for logging
- Methods support lazy loading (work with pre-loaded or on-demand knowledge sources)
- All methods include YARD documentation comments

**Code Strengths**:
1. **Consistent API Design**: All three lookup methods follow the same pattern and return format
2. **Robust Error Handling**: Graceful handling of not-found cases without exceptions
3. **Lazy Loading Support**: Methods work whether knowledge sources are pre-loaded or not
4. **Metadata Completeness**: Returned documents include proper source attribution and type information
5. **Section Support**: Man page lookup supports optional section parameter as specified

**Refactoring Performed**: None required - code quality is excellent.

### Compliance Check

- ✅ **Coding Standards**: Code follows Ruby conventions and project patterns
- ✅ **Project Structure**: Files are in correct locations per architecture
- ✅ **Testing Strategy**: Comprehensive unit and integration tests covering all scenarios
- ✅ **All ACs Met**: All 8 acceptance criteria are fully implemented and tested

### Test Coverage Assessment

**Test File**: `test/test_knowledge_source_lookup.rb`

**Coverage Highlights**:
- ✅ Tests for all three lookup methods (man pages, markdown, MITRE)
- ✅ Success cases with existing items
- ✅ Failure cases with non-existent items
- ✅ Edge cases (empty strings, nil, invalid types)
- ✅ Section parameter support for man pages
- ✅ Path normalization for markdown documents
- ✅ Sub-technique support for MITRE (e.g., T1003.001)
- ✅ Integration tests with knowledge source manager
- ✅ Format compatibility verification

**Test Quality**: Excellent - tests cover all acceptance criteria and edge cases.

### Improvements Checklist

- [x] All acceptance criteria implemented correctly
- [x] Comprehensive test coverage
- [x] Proper error handling and logging
- [x] YARD documentation included
- [ ] Consider adding performance benchmarks for lookup speed (future enhancement)
- [ ] Consider adding caching for frequently accessed items (future optimization)

### Security Review

✅ **No security concerns identified**: 
- Lookup methods only read data, no write operations
- No path traversal vulnerabilities (man pages and MITRE use validated identifiers)
- Document paths validated for suspicious patterns (parent directory references)
- All input validation implemented correctly

### Performance Considerations

✅ **Performance is acceptable**:
- Identifier-based lookups are direct (O(1) or small O(n) for MITRE array search)
- No full knowledge base scans required
- Lazy loading support prevents unnecessary pre-loading
- Methods are efficient for production use

### Files Reviewed During Review

**Modified Files**:
- `knowledge_bases/sources/man_pages/man_page_knowledge.rb` - Added `get_man_page_by_name` method
- `knowledge_bases/sources/markdown_files/markdown_knowledge.rb` - Added `get_document_by_path` method
- `knowledge_bases/mitre_attack_knowledge.rb` - Added `get_technique_by_id` module method

**New Files**:
- `test/test_knowledge_source_lookup.rb` - Comprehensive test suite

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.1-identifier-based-lookup.yml`

All acceptance criteria met, comprehensive test coverage, production-ready implementation. No blocking issues identified.

### Recommended Status

✅ **Ready for Done** - Story implementation is complete and meets all quality standards.

