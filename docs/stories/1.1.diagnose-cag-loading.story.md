# Story 1.1: Diagnose CAG Document Loading Failures

**Epic**: Epic 1 - LLM Feature Stabilization
**Story ID**: 1.1
**Priority**: Critical
**Estimated Effort**: 2-3 days
**Dependencies**: None (starting point)

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** to identify the root causes preventing CAG from loading and caching documents,
**so that** I can determine the most efficient fix approach (repair vs reimplementation).

---

## Acceptance Criteria

1. All code paths for document loading in cag_manager.rb are traced and documented
2. Failure points in man page and lab sheet loading are identified with specific error messages
3. In-memory graph client behavior is analyzed for caching issues
4. Knowledge source integration (knowledge_bases/sources/man_pages/) is validated
5. Root cause analysis document created listing all issues found
6. Recommendation made: repair existing implementation or reimplement with simpler approach
7. Time estimate provided for chosen fix approach

---

## Integration Verification

- **IV1**: Verify RAG system continues to function correctly during CAG diagnosis
- **IV2**: Verify existing bot configurations remain valid
- **IV3**: Verify no performance degradation to running systems during diagnostic testing

---

## Tasks / Subtasks

### Phase 1: Document Loading Path Analysis (AC: 1, 2, 4)

- [ ] **Task 1.1: Trace CAG Manager Document Loading**
  - [ ] Read cag/cag_manager.rb focusing on `load_knowledge` and `add_knowledge_triplet` methods
  - [ ] Identify all method calls related to document loading
  - [ ] Document the complete call chain from entry point to knowledge source
  - [ ] Note any error handling or logging statements in the path

- [ ] **Task 1.2: Analyze Knowledge Source Integration**
  - [ ] Read knowledge_bases/sources/man_pages/man_page_knowledge.rb
  - [ ] Examine `get_rag_documents` and `get_cag_triplets` methods
  - [ ] Verify how man page processor (knowledge_bases/utils/man_page_processor.rb) generates triplets
  - [ ] Check if markdown/lab sheet loading follows same pattern
  - [ ] Document any differences between RAG and CAG knowledge source paths

- [ ] **Task 1.3: Identify Failure Points**
  - [ ] Run CAG system in debug mode with Print.debug enabled
  - [ ] Attempt to load test man pages (e.g., 'ls', 'grep', 'netstat')
  - [ ] Capture all error messages and stack traces
  - [ ] Document exact line numbers where failures occur
  - [ ] Compare error patterns between man pages and lab sheets (markdown files)

###Phase 2: In-Memory Graph Client Analysis (AC: 3)

- [ ] **Task 2.1: Review Graph Client Implementation**
  - [ ] Read cag/in_memory_graph_client.rb completely
  - [ ] Examine node creation (`create_node`) and relationship creation (`create_relationship`) methods
  - [ ] Check index maintenance logic (`update_node_indexes`, `update_relationship_indexes`)
  - [ ] Verify search functionality (`search_nodes`, `find_nodes_by_property`)
  - [ ] Document any obvious bugs or logic errors

- [ ] **Task 2.2: Test Graph Client in Isolation**
  - [ ] Create minimal test script to exercise graph client directly
  - [ ] Test node creation with sample data
  - [ ] Test relationship creation between nodes
  - [ ] Test node retrieval by property (simulating knowledge lookup)
  - [ ] Document which operations succeed vs fail

- [ ] **Task 2.3: Analyze Caching Behavior**
  - [ ] Check if nodes persist in memory after creation
  - [ ] Verify indexes are correctly maintained
  - [ ] Test retrieval of previously stored nodes
  - [ ] Document memory usage and performance characteristics
  - [ ] Identify any cache invalidation or cleanup issues

### Phase 3: Root Cause Analysis & Recommendation (AC: 5, 6, 7)

- [ ] **Task 3.1: Compile Findings Document**
  - [ ] Create root_cause_analysis.md in docs/stories/ directory
  - [ ] List all identified failure points with file:line references
  - [ ] Document error messages and their causes
  - [ ] Categorize issues: critical blockers vs minor issues
  - [ ] Include code snippets demonstrating problems

- [ ] **Task 3.2: Evaluate Fix Approaches**
  - [ ] **Option A: Repair Existing Knowledge Graph**
    - List specific fixes needed in cag_manager.rb and in_memory_graph_client.rb
    - Estimate effort for each fix
    - Assess risk of cascading issues
  - [ ] **Option B: Simplified CAG Implementation**
    - Design simpler caching approach (pre-cached prompts, simple hash map, file-based cache)
    - Estimate effort for reimplementation
    - Assess maintainability benefits
  - [ ] **Option C: RAG-Only Fallback**
    - Document what would be lost by abandoning CAG
    - Verify RAG can meet all use case requirements

- [ ] **Task 3.3: Make Recommendation**
  - [ ] Compare effort, risk, and maintainability of each option
  - [ ] Recommend single approach with clear rationale
  - [ ] Provide time estimate for recommended approach (must fit 2-week window)
  - [ ] Document fallback plan if recommended approach exceeds estimate

### Phase 4: Integration Verification (IV1, IV2, IV3)

- [ ] **Task 4.1: Verify RAG System Integrity**
  - [ ] Run existing RAG tests (if any in test/ directory)
  - [ ] Manually test RAG document retrieval with sample query
  - [ ] Confirm RAG manager functionality unchanged
  - [ ] Document any RAG issues discovered during CAG diagnosis

- [ ] **Task 4.2: Verify Bot Configuration Compatibility**
  - [ ] Check existing XML configs in config/ directory still parse correctly
  - [ ] Verify bot startup succeeds with CAG disabled
  - [ ] Test that diagnostic work doesn't break any configuration options

- [ ] **Task 4.3: Performance Regression Check**
  - [ ] Measure bot startup time before and after diagnostic work
  - [ ] Check memory usage hasn't increased
  - [ ] Verify IRC bot responsiveness unchanged
  - [ ] Document any performance impacts

---

## Dev Notes

### CAG System Architecture Overview

**Purpose**: Cache-Augmented Generation (CAG) is an alternative to RAG that uses cached knowledge structures for faster knowledge retrieval.
[Source: docs/prd.md#1.5 Goals and Background Context]

**Current Implementation**: Uses in-memory knowledge graph with nodes and relationships
[Source: docs/development/architecture.md#4 Knowledge Enhancement System]

**Problem**: CAG fails to load and cache documents (man pages, lab sheets) preventing performance testing
[Source: docs/prd.md#1.2 Current Project State]

### Key Files and Components

**CAG Manager** (`cag/cag_manager.rb`):
- Main coordinator for CAG operations
- Methods: `setup`, `extract_entities`, `expand_context_with_entities`, `get_context_for_query`
- Integrates with knowledge graph client and entity extractor
- [Source: docs/development/architecture.md#214-216]

**In-Memory Graph Client** (`cag/in_memory_graph_client.rb`):
- Implements knowledge graph interface
- Stores nodes and relationships in memory
- Provides indexing for fast lookups
- Methods: `create_node`, `create_relationship`, `find_nodes_by_property`, `search_nodes`
- [Source: Codebase inspection]

**Knowledge Graph Interface** (`cag/knowledge_graph_interface.rb`):
- Abstract base class defining graph operations
- Contract that all graph clients must implement
- [Source: Codebase inspection]

**Man Page Knowledge Source** (`knowledge_bases/sources/man_pages/man_page_knowledge.rb`):
- Loads man pages into both RAG and CAG formats
- Methods: `get_rag_documents`, `get_cag_triplets`
- Uses man_page_processor.rb for parsing
- [Source: Codebase inspection]

### Integration Points

**RAG/CAG Manager** (`rag_cag_manager.rb`):
- Unified coordinator that can enable CAG, RAG, or both
- Combines contexts from both systems
- Must continue working even if CAG fails
- [Source: docs/development/architecture.md#215-243]

**Bot Manager** (`bot_manager.rb`):
- Initializes RAG/CAG based on bot XML configuration
- Passes enhanced context to LLM clients
- Must handle CAG failures gracefully
- [Source: docs/development/architecture.md#116-154]

### Configuration

**XML Bot Configuration**:
```xml
<rag_cag_enabled>true</rag_cag_enabled>
<rag_enabled>true</rag_enabled>
<cag_enabled>true</cag_enabled>
```
[Source: docs/development/architecture.md#314-351]

### Project Structure for CAG

```
opt_hackerbot/
├── cag/                              # CAG system implementation
│   ├── cag_manager.rb               # Main coordinator (FOCUS HERE)
│   ├── in_memory_graph_client.rb    # Current caching impl (DIAGNOSE THIS)
│   ├── knowledge_graph_interface.rb # Abstract interface
│   └── in_memory_graph_offline_client.rb
├── knowledge_bases/
│   ├── sources/
│   │   └── man_pages/
│   │       └── man_page_knowledge.rb  # Knowledge source (CHECK THIS)
│   └── utils/
│       └── man_page_processor.rb      # Man page parsing
└── rag_cag_manager.rb               # Unified coordinator
```
[Source: docs/prd.md#3.3 Code Organization and Standards]

### Coding Standards

**Ruby Conventions**:
- snake_case for files, methods, variables
- CamelCase for class names
- Error handling with `rescue` blocks and `Print.err` logging
- Factory pattern for component creation
- Interface-based abstractions (base classes with `raise NotImplementedError`)

[Source: docs/prd.md#3.3 Code Organization and Standards]

**Error Logging**:
```ruby
Print.err "Error message: #{e.message}"
Print.err e.backtrace.inspect
```
[Source: Codebase pattern observation]

### Design Patterns

**Factory Pattern**: Used for LLM clients and knowledge sources
**Strategy Pattern**: Different implementations of same interface
**Observer Pattern**: Streaming responses and cache invalidation
[Source: docs/development/architecture.md#416-432]

### Known Constraints

- **Offline-first**: System must work without external dependencies
- **Memory limit**: ≤ 4GB for typical knowledge bases (1000+ documents)
- **Startup time**: ≤ 60 seconds with typical knowledge base
- **No external database**: All data structures in-memory only

[Source: docs/prd.md#2.2 Non-Functional Requirements]

### Previous Story Insights

**None** - This is the first story in the epic.

### Critical Success Factors

1. **Thoroughness**: Must trace ALL code paths, not just obvious ones
2. **Documentation**: Root cause analysis must be detailed enough for someone else to understand
3. **Decision Quality**: Recommendation must be data-driven, not gut-feel
4. **Time-boxing**: Keep diagnosis focused - 2-3 days maximum
5. **Reproducibility**: Document steps to reproduce failures so fixes can be verified

---

## Testing

### Testing Strategy

**For This Story**: Diagnostic work, no new tests required. However, must verify existing functionality:

1. **Manual Testing**:
   - Attempt CAG document loading with debug output
   - Test isolated graph client operations
   - Verify RAG system still works

2. **Existing Test Verification**:
   - Run any existing tests in test/ directory
   - Verify no regressions introduced

3. **Documentation Testing**:
   - Root cause analysis document should enable another developer to reproduce findings
   - Recommendation should be clear enough to guide implementation

### Test File Locations

Tests located in: `test/` directory
Test naming pattern: `test_*.rb`
[Source: docs/prd.md#3.2 Integration Approach - Testing Integration Strategy]

### Testing Framework

Ruby test framework (exact framework determined by existing test files)
Must run in Nix development environment
[Source: docs/prd.md#3.1 Existing Technology Stack]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | v1.0 | Initial story creation | SM Agent (Bob) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_This section will be populated by QA Agent after story completion._

---

**Story prepared by**: Scrum Master Agent (Bob)
**Ready for**: Developer Agent implementation
**Next Story**: 1.2 - Implement CAG Fix or Simplified Reimplementation (depends on findings from this story)
