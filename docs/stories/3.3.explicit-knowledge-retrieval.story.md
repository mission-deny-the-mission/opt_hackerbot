# Story 3.3: Implement Explicit Knowledge Retrieval in Context System

**Epic**: Epic 3 - Stage-Aware Context Injection
**Story ID**: 3.3
**Priority**: Critical
**Estimated Effort**: 4-5 days
**Dependencies**: Story 3.1, Story 3.2

---

## Status

**Draft**

---

## Story

**As a** bot trainer,
**I want** the bot to retrieve and include explicitly configured knowledge items during attack stages,
**so that** students receive precisely targeted knowledge relevant to the current training stage.

---

## Acceptance Criteria

1. `get_enhanced_context` in `bot_manager.rb` reads attack-level context configuration from bot state
2. When man pages specified in context_config, retrieve them via `ManPageKnowledgeSource.get_man_page_by_name()`
3. When documents specified in context_config, retrieve them via `MarkdownKnowledgeSource.get_document_by_path()`
4. When MITRE techniques specified in context_config, retrieve them via `MITREAttackKnowledge.get_technique_by_id()`
5. Explicitly retrieved items formatted and included in context
6. Context includes clear source attribution (e.g., "Source: man page 'nmap'", "Source: MITRE ATT&CK T1003")
7. Optional fallback: if explicit items not found, log warning but continue (or fall back to similarity search)
8. Integration tests verify explicit knowledge retrieval during attack stages
9. Explicit knowledge retrieval works alongside existing RAG similarity search (optional combination)
10. Per-attack context config is read based on current attack index (`current_attack`)

---

## Integration Verification

- **IV1**: Verify explicit knowledge retrieval doesn't break existing RAG similarity search functionality
- **IV2**: Verify context assembly handles both explicit items and similarity search results correctly
- **IV3**: Verify performance impact is acceptable (lookup methods should be fast)
- **IV4**: Verify backward compatibility - bots without context_config use existing behavior unchanged

---

## Tasks / Subtasks

### Phase 1: Enhance get_enhanced_context Method (AC: 1, 10)

- [ ] **Task 1.1: Modify get_enhanced_context to Accept Attack Index**
  - [ ] Locate `get_enhanced_context(bot_name, user_message)` method in `bot_manager.rb`
  - [ ] Add optional parameter `attack_index: nil` to method signature
  - [ ] When `attack_index` provided, retrieve current attack context_config
  - [ ] Access context_config via: `@bots[bot_name]['attacks'][attack_index]['context_config']`
  - [ ] Return early if no context_config exists (use existing RAG behavior)

- [ ] **Task 1.2: Update Method Calls to Pass Attack Index**
  - [ ] Locate all calls to `get_enhanced_context` (likely in IRC message handler)
  - [ ] Get current attack index: `current_attack = @bots[bot_name]['current_attack']`
  - [ ] Pass attack index: `get_enhanced_context(bot_name, user_message, attack_index: current_attack)`
  - [ ] Ensure attack index is valid (within bounds of attacks array)

- [ ] **Task 1.3: Extract Context Config from Attack**
  - [ ] Check if attack has context_config: `attack['context_config']`
  - [ ] Check if context_config has any non-empty arrays (man_pages, documents, mitre_techniques)
  - [ ] Return early to existing RAG behavior if context_config empty/missing
  - [ ] Extract arrays: `man_pages`, `documents`, `mitre_techniques` from context_config

### Phase 2: Implement Explicit Knowledge Retrieval (AC: 2, 3, 4)

- [ ] **Task 2.1: Retrieve Man Pages via Knowledge Source**
  - [ ] Get knowledge source manager instance (likely `@rag_manager` or similar)
  - [ ] Access ManPageKnowledgeSource from knowledge source manager
  - [ ] For each man page name in `context_config[:man_pages]`:
    - [ ] Call `man_page_source.get_man_page_by_name(command_name)`
    - [ ] Handle nil return (not found) - log warning with Print.warn
    - [ ] Collect successful retrievals into array
  - [ ] Return array of RAG documents from man pages

- [ ] **Task 2.2: Retrieve Documents via Knowledge Source**
  - [ ] Get MarkdownKnowledgeSource from knowledge source manager
  - [ ] For each document path in `context_config[:documents]`:
    - [ ] Call `markdown_source.get_document_by_path(file_path)`
    - [ ] Handle nil return (not found) - log warning with Print.warn
    - [ ] Collect successful retrievals into array
  - [ ] Return array of RAG documents from documents

- [ ] **Task 2.3: Retrieve MITRE Techniques via Knowledge Source**
  - [ ] For each technique ID in `context_config[:mitre_techniques]`:
    - [ ] Call `MITREAttackKnowledge.get_technique_by_id(technique_id)`
    - [ ] Handle nil return (not found) - log warning with Print.warn
    - [ ] Collect successful retrievals into array
  - [ ] Return array of RAG documents from MITRE techniques

- [ ] **Task 2.4: Combine Explicit Knowledge Items**
  - [ ] Combine all retrieved RAG documents from man pages, documents, and MITRE techniques
  - [ ] Store combined array for formatting
  - [ ] Track which items were successfully retrieved vs not found (for logging)

### Phase 3: Context Formatting with Source Attribution (AC: 5, 6)

- [ ] **Task 3.1: Format Explicit Knowledge Items**
  - [ ] Create formatter function for explicit knowledge items
  - [ ] Group items by type (man pages, documents, MITRE techniques)
  - [ ] Format each item with clear source attribution:
    - Man pages: `"Source: man page 'nmap'"`
    - Documents: `"Source: document 'attack-guide.md'"`
    - MITRE: `"Source: MITRE ATT&CK T1003"`
  - [ ] Include document content in formatted context

- [ ] **Task 3.2: Integrate Explicit Context into Enhanced Context**
  - [ ] Get existing enhanced context structure from RAG manager (if RAG enabled)
  - [ ] Combine explicit knowledge with existing RAG context
  - [ ] Prepend or append explicit context section to enhanced context
  - [ ] Format: `"Explicit Knowledge:\n[formatted explicit items]\n\nSimilarity Search Results:\n[existing RAG context]"`
  - [ ] Or replace RAG context entirely if explicit context only (configurable behavior)

- [ ] **Task 3.3: Update Enhanced Context Structure**
  - [ ] Enhanced context structure should indicate explicit vs similarity-based sources
  - [ ] Update `enhanced_context` hash to include:
    - `explicit_context`: Array of explicitly retrieved items
    - `explicit_sources`: List of source identifiers
    - `has_explicit`: Boolean flag indicating explicit context present
  - [ ] Maintain backward compatibility with existing enhanced_context structure

### Phase 4: Fallback and Error Handling (AC: 7)

- [ ] **Task 4.1: Implement Fallback to Similarity Search**
  - [ ] When explicit items not found, log warning but continue
  - [ ] Option 1: Fall back to existing RAG similarity search if explicit items not found
  - [ ] Option 2: Return only successfully retrieved explicit items (no fallback)
  - [ ] Make behavior configurable (prefer explicit, prefer similarity, or combine)
  - [ ] Default behavior: Use explicit items if found, otherwise fall back to similarity search

- [ ] **Task 4.2: Logging for Explicit Knowledge Retrieval**
  - [ ] Log info when explicit knowledge retrieval triggered: `Print.info "Using explicit knowledge for attack #{attack_index}"`
  - [ ] Log warning for each item not found: `Print.warn "Man page 'invalid_cmd' not found, skipping"`
  - [ ] Log summary: Number of items requested vs successfully retrieved
  - [ ] Log debug info: Which knowledge sources were accessed

- [ ] **Task 4.3: Handle Edge Cases**
  - [ ] Handle empty context_config (no explicit items specified)
  - [ ] Handle all items not found (empty result from explicit retrieval)
  - [ ] Handle partial retrieval (some items found, some not)
  - [ ] Handle knowledge source not initialized (should not crash)

### Phase 5: Integration with Context Assembly (AC: 9)

- [ ] **Task 5.1: Integrate with assemble_prompt Method**
  - [ ] Locate `assemble_prompt` method in `bot_manager.rb`
  - [ ] Verify explicit context is included in enhanced_context passed to assemble_prompt
  - [ ] Ensure explicit context formatted correctly for LLM consumption
  - [ ] Test that assemble_prompt correctly incorporates explicit context

- [ ] **Task 5.2: Support Optional Combination with Similarity Search**
  - [ ] When both explicit context and similarity search available:
    - [ ] Option to combine (explicit + similarity)
    - [ ] Option to prefer explicit (explicit only if available)
    - [ ] Option to prefer similarity (similarity only if explicit not available)
  - [ ] Make behavior configurable per-bot or per-attack
  - [ ] Default: Use explicit if available, otherwise similarity search

### Phase 6: Testing (AC: 8)

- [ ] **Task 6.1: Create Integration Test File**
  - [ ] Create `test/test_explicit_knowledge_retrieval.rb`
  - [ ] Set up test framework using Minitest
  - [ ] Create test fixtures with XML configs containing context_config

- [ ] **Task 6.2: Test Explicit Knowledge Retrieval**
  - [ ] Test retrieval of man pages during attack stage
  - [ ] Test retrieval of documents during attack stage
  - [ ] Test retrieval of MITRE techniques during attack stage
  - [ ] Test combination of all three types
  - [ ] Test retrieval with missing items (not found cases)
  - [ ] Test source attribution in formatted context

- [ ] **Task 6.3: Test Attack Stage Integration**
  - [ ] Test that correct attack's context_config is used (based on current_attack index)
  - [ ] Test that context_config changes when attack stage advances
  - [ ] Test attacks without context_config use existing RAG behavior
  - [ ] Test attacks with empty context_config use existing RAG behavior

- [ ] **Task 6.4: Test Context Assembly**
  - [ ] Test that explicit context is included in final prompt
  - [ ] Test that explicit context has proper source attribution
  - [ ] Test combination of explicit + similarity search
  - [ ] Test fallback behavior when explicit items not found

- [ ] **Task 6.5: Test Backward Compatibility**
  - [ ] Test bots without context_config work unchanged
  - [ ] Test existing RAG similarity search still works
  - [ ] Test no performance degradation for bots without context_config

---

## Dev Notes

### Previous Story Insights

**Story 3.1**: Identifier-based lookup methods available:
- `ManPageKnowledgeSource.get_man_page_by_name(command_name, section: nil)` → Returns RAG document or nil
- `MarkdownKnowledgeSource.get_document_by_path(file_path)` → Returns RAG document or nil
- `MITREAttackKnowledge.get_technique_by_id(technique_id)` → Returns RAG document or nil

**Story 3.2**: Context config stored in bot state:
- Location: `@bots[bot_name]['attacks'][attack_index]['context_config']`
- Structure: `{ man_pages: [...], documents: [...], mitre_techniques: [...] }`
- Accessible during attack stages via current attack index

### Data Models

**Enhanced Context Structure** (existing in bot_manager.rb):
```ruby
enhanced_context = {
  original_query: String,
  rag_context: Hash,           # Existing similarity search results
  combined_context: String,      # Combined formatted context
  sources: Array[String],        # Source identifiers
  timestamp: Time,
  # New additions:
  explicit_context: Array[Hash],  # Explicitly retrieved RAG documents
  explicit_sources: Array[String], # Source identifiers for explicit items
  has_explicit: Boolean          # Flag indicating explicit context present
}
```

**Context Config Structure** (from Story 3.2):
```ruby
context_config = {
  man_pages: Array[String],       # e.g., ['nmap', 'netcat']
  documents: Array[String],       # e.g., ['attack-guide.md']
  mitre_techniques: Array[String] # e.g., ['T1003', 'T1059.001']
}
```

[Source: analysis of `bot_manager.rb` get_enhanced_context method, Story 3.2]

### API Specifications

**get_enhanced_context Method Signature** (to be modified):
```ruby
def get_enhanced_context(bot_name, user_message, attack_index: nil)
  # Existing RAG logic
  # New: Check for explicit knowledge if attack_index provided
  # Return enhanced_context with explicit items included
end
```

**Knowledge Source Access**:
- Need to determine how to access knowledge sources from bot_manager
- Options:
  1. Access via `@rag_manager.knowledge_source_manager` (if available)
  2. Access via global knowledge source manager instance
  3. Create knowledge source instances on-demand
- Verify actual structure in codebase

**MITREAttackKnowledge Access**:
- Module method: `MITREAttackKnowledge.get_technique_by_id(technique_id)`
- No instance needed (module-level method)

[Source: code analysis of bot_manager.rb, Story 3.1 implementation]

### File Locations

**Files to Modify**:
- `bot_manager.rb` - Modify `get_enhanced_context` method, update method calls, integrate with context assembly

**Files to Create**:
- `test/test_explicit_knowledge_retrieval.rb` - Integration tests for explicit knowledge retrieval

[Source: `docs/architecture/source-tree.md`]

### Testing Requirements

**Test Framework**: Minitest
**Test Location**: `test/test_explicit_knowledge_retrieval.rb`

**Test Setup**:
- Create test XML config with context_config examples
- Initialize bot_manager with test config
- Set up knowledge sources (man pages, markdown, MITRE)
- Create test fixtures for knowledge items

**Test Patterns**:
```ruby
require 'minitest/autorun'
require_relative 'test_helper'
require_relative '../bot_manager.rb'
# ... test implementation
```

**Integration Test Requirements**:
- Test full flow: XML config → context_config parsing → explicit retrieval → context assembly
- Test attack stage progression and context_config changes
- Test interaction with existing RAG system
- Test error handling and fallback behavior

[Source: `docs/architecture/coding-standards.md`, existing test patterns]

### Technical Constraints

**Access to Knowledge Sources**:
- Need to verify how bot_manager accesses knowledge sources
- May need to add accessor method or modify knowledge source manager integration
- Must not break existing RAG system access patterns

**Performance Considerations**:
- Identifier-based lookups should be fast (direct access, no vector search)
- Multiple lookups (multiple man pages, documents, techniques) should still be acceptable
- Consider caching lookups if same items requested multiple times

**Backward Compatibility**:
- Must not break existing `get_enhanced_context` behavior
- When `attack_index: nil` or no context_config, use existing RAG behavior
- Existing bots without context_config must work unchanged

[Source: `docs/architecture.md`, epic description]

### Technical Implementation Details

**Method Modification Strategy**:
1. Add optional `attack_index: nil` parameter to `get_enhanced_context`
2. Early return if no attack_index provided (existing behavior)
3. Get context_config from attack at attack_index
4. Early return if no context_config or empty context_config (existing behavior)
5. Retrieve explicit knowledge items using lookup methods from Story 3.1
6. Format explicit items with source attribution
7. Combine with or replace existing RAG context
8. Return enhanced_context with explicit items included

**Knowledge Source Access Pattern**:
```ruby
# Need to determine actual pattern from codebase
# Option 1: Via RAG manager
man_page_source = @rag_manager.knowledge_source_manager.sources['man_pages']

# Option 2: Direct instantiation (if needed)
man_page_source = ManPageKnowledgeSource.new(config)
```

**Context Formatting**:
```
Explicit Knowledge Sources:
Source: man page 'nmap'
[nmap man page content]

Source: document 'attack-guide.md'
[document content]

Source: MITRE ATT&CK T1003
[MITRE technique content]

---
Similarity Search Results:
[existing RAG context]
```

**Fallback Strategy**:
- If explicit items requested but none found: Fall back to similarity search
- If some explicit items found, some not: Use found items, log warnings for missing
- Log summary: "Retrieved 2/3 explicit knowledge items, using similarity search for remainder"

[Source: epic description, code analysis]

### Error Handling

**Knowledge Source Access Errors**:
- If knowledge source manager not initialized: Log error, fall back to similarity search
- If specific knowledge source not available: Log warning, skip that type, continue with others

**Retrieval Errors**:
- Item not found: Log warning per item, continue retrieving other items
- Processing error: Log error, skip item, continue
- All items not found: Log summary warning, fall back to similarity search

**Integration Errors**:
- Invalid attack_index: Log error, use existing RAG behavior
- Context_config parsing error: Log warning, use existing RAG behavior
- Must never crash - always have fallback to existing behavior

[Source: error handling patterns in existing codebase]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used

_[To be populated by Dev Agent]_

### Debug Log References

_[To be populated by Dev Agent]_

### Completion Notes List

_[To be populated by Dev Agent]_

### File List

_[To be populated by Dev Agent]_

---

## QA Results

_[To be populated by QA Agent]_

