# Story 3.2: XML Configuration for Explicit Knowledge Selection

**Epic**: Epic 3 - Stage-Aware Context Injection
**Story ID**: 3.2
**Priority**: Critical
**Estimated Effort**: 2-3 days
**Dependencies**: Story 3.1

---

## Status

**Ready for Review**

---

## Story

**As a** bot trainer,
**I want** to configure explicit knowledge sources per attack stage in XML configuration,
**so that** I can precisely control which knowledge items are available at each training stage.

---

## Acceptance Criteria

1. XML schema supports optional `<context_config>` element within `<attack>` elements
2. `<man_pages>` sub-element accepts comma-separated list (e.g., "nmap,netcat,tcpdump") OR individual `<page>` elements (e.g., `<page>nmap</page><page>netcat</page>`)
3. `<documents>` sub-element accepts comma-separated list (e.g., "attack-guide.md,docs/pentest-primer.md") OR individual `<doc>` elements (e.g., `<doc>attack-guide.md</doc>`)
4. `<mitre_techniques>` sub-element accepts comma-separated list (e.g., "T1003,T1059.001") OR individual `<technique>` elements (e.g., `<technique>T1003</technique><technique>T1059.001</technique>`)
5. Configuration parser reads and stores attack-level context settings in bot state
6. Default behavior when no attack-level config specified (use existing RAG behavior unchanged)
7. Configuration examples added to existing XML config files (e.g., `config/teaching_assistant_bot.xml`)
8. XML schema validation ensures valid context configuration (no invalid elements or malformed structure)
9. Parser handles both empty `<context_config>` and missing `<context_config>` gracefully
10. Context config stored per attack in bot state: `@bots[bot_name]['attacks'][index]['context_config']`

---

## Integration Verification

- **IV1**: Verify XML parser doesn't break existing bot configurations without context_config
- **IV2**: Verify context config storage doesn't interfere with existing attack configuration (prompt, get_shell, quiz, etc.)
- **IV3**: Verify configuration examples validate correctly with XML schema
- **IV4**: Verify backward compatibility - bots without context_config work unchanged

---

## Tasks / Subtasks

### Phase 1: XML Schema Extension (AC: 1, 8)

- [x] **Task 1.1: Update XML Configuration Parser for Context Config**
  - [x] Locate XML parsing code in `bot_manager.rb` (search for `parse_attacks` or attack parsing)
  - [x] Find method that parses `<attack>` elements (likely in `parse_attacks` or similar)
  - [x] Add parsing logic for optional `<context_config>` element
  - [x] Store context_config in attack hash alongside existing attack fields (prompt, get_shell, etc.)
  - [x] Ensure parsing is optional (doesn't fail if context_config missing)

- [x] **Task 1.2: Implement Parsing for Man Pages Element**
  - [x] Parse `<man_pages>` element with two formats:
    - Comma-separated: `<man_pages>nmap,netcat,tcpdump</man_pages>`
    - Individual elements: `<man_pages><page>nmap</page><page>netcat</page></man_pages>`
  - [x] Normalize to array format: `['nmap', 'netcat', 'tcpdump']`
  - [x] Handle empty `<man_pages>` element (empty array)
  - [x] Handle missing `<man_pages>` element (nil or empty array)

- [x] **Task 1.3: Implement Parsing for Documents Element**
  - [x] Parse `<documents>` element with two formats:
    - Comma-separated: `<documents>attack-guide.md,docs/pentest.md</documents>`
    - Individual elements: `<documents><doc>attack-guide.md</doc><doc>docs/pentest.md</doc></documents>`
  - [x] Normalize to array format: `['attack-guide.md', 'docs/pentest.md']`
  - [x] Handle empty `<documents>` element (empty array)
  - [x] Handle missing `<documents>` element (nil or empty array)

- [x] **Task 1.4: Implement Parsing for MITRE Techniques Element**
  - [x] Parse `<mitre_techniques>` element with two formats:
    - Comma-separated: `<mitre_techniques>T1003,T1059.001</mitre_techniques>`
    - Individual elements: `<mitre_techniques><technique>T1003</technique><technique>T1059.001</technique></mitre_techniques>`
  - [x] Normalize to array format: `['T1003', 'T1059.001']`
  - [x] Handle empty `<mitre_techniques>` element (empty array)
  - [x] Handle missing `<mitre_techniques>` element (nil or empty array)

- [x] **Task 1.5: Store Context Config in Bot State**
  - [x] Store parsed context_config in attack hash structure:
    ```ruby
    attack['context_config'] = {
      man_pages: ['nmap', 'netcat'],
      documents: ['attack-guide.md'],
      mitre_techniques: ['T1003', 'T1059.001']
    }
    ```
  - [x] Ensure context_config is stored alongside existing attack fields
  - [x] Verify accessible via: `@bots[bot_name]['attacks'][attack_index]['context_config']`

### Phase 2: Backward Compatibility (AC: 6, 9)

- [x] **Task 2.1: Ensure Default Behavior Preserved**
  - [x] Verify when `<context_config>` missing, attack uses existing RAG behavior
  - [x] Verify when `<context_config>` empty, attack uses existing RAG behavior
  - [x] Verify when all sub-elements empty, attack uses existing RAG behavior
  - [x] Test existing bots without context_config still work correctly

- [x] **Task 2.2: Handle Edge Cases in Parsing**
  - [x] Handle `<context_config></context_config>` (empty element)
  - [x] Handle `<context_config/>` (self-closing empty element)
  - [x] Handle whitespace-only values (trim whitespace)
  - [x] Handle duplicate values (deduplicate arrays)

### Phase 3: Configuration Examples (AC: 7)

- [x] **Task 3.1: Add Example to Teaching Assistant Bot Config**
  - [x] Open `config/teaching_assistant_bot.xml`
  - [x] Add `<context_config>` example to one attack element
  - [x] Demonstrate comma-separated format for man pages
  - [x] Demonstrate individual element format for documents
  - [x] Demonstrate MITRE techniques configuration
  - [x] Verify example validates and parses correctly

- [x] **Task 3.2: Create Enhanced Example Config File**
  - [x] Create or update `config/example_stage_aware_context.xml`
  - [x] Include multiple attacks with different context_config patterns
  - [x] Show progression: early attacks with basic knowledge, later attacks with advanced knowledge
  - [x] Include comments explaining context_config usage

### Phase 4: Validation and Error Handling (AC: 8, 9)

- [x] **Task 4.1: Add XML Schema Validation**
  - [x] Verify context_config elements follow correct XML structure
  - [x] Validate that man_pages contains only text or <page> elements
  - [x] Validate that documents contains only text or <doc> elements
  - [x] Validate that mitre_techniques contains only text or <technique> elements
  - [x] Log warnings for invalid structures (don't fail parsing)

- [x] **Task 4.2: Add Configuration Validation**
  - [x] Validate technique IDs match MITRE ATT&CK format (T#### or T####.###)
  - [x] Log warnings for invalid technique IDs (don't fail, but warn)
  - [x] Validate document paths are reasonable (don't fail, but log warnings)
  - [x] Log warnings for duplicate entries in lists

### Phase 5: Testing (AC: 6, 9, 10)

- [x] **Task 5.1: Create Test File for XML Context Config Parsing**
  - [x] Create `test/test_xml_context_config.rb`
  - [x] Set up test framework using Minitest
  - [x] Create test fixtures with XML configs containing context_config

- [x] **Task 5.2: Test Context Config Parsing**
  - [x] Test parsing of comma-separated man_pages
  - [x] Test parsing of individual <page> elements
  - [x] Test parsing of comma-separated documents
  - [x] Test parsing of individual <doc> elements
  - [x] Test parsing of comma-separated MITRE techniques
  - [x] Test parsing of individual <technique> elements
  - [x] Test missing context_config (should not fail)
  - [x] Test empty context_config (should not fail)
  - [x] Test mixed formats (some comma-separated, some individual elements)

- [x] **Task 5.3: Test Backward Compatibility**
  - [x] Test existing XML configs without context_config still parse correctly
  - [x] Test existing XML configs with context_config work correctly
  - [x] Test bots with no context_config still use existing RAG behavior

- [x] **Task 5.4: Test Context Config Storage**
  - [x] Verify context_config stored correctly in bot state
  - [x] Verify context_config accessible via `@bots[bot_name]['attacks'][index]['context_config']`
  - [x] Test multiple attacks with different context_configs

---

## Dev Notes

### Previous Story Insights

**Story 3.1**: Identifier-based lookup methods implemented in:
- `ManPageKnowledgeSource.get_man_page_by_name(command_name, section: nil)`
- `MarkdownKnowledgeSource.get_document_by_path(file_path)`
- `MITREAttackKnowledge.get_technique_by_id(technique_id)`

These methods return RAG document format compatible with existing system. Context config parsing will reference these methods by identifier.

### Data Models

**Attack Configuration Structure** (existing in bot_manager.rb):
```ruby
attack = {
  'prompt' => String,
  'get_shell' => String,
  'quiz' => { ... },
  'system_prompt' => String,  # Optional
  # New addition:
  'context_config' => {
    man_pages: Array[String],          # e.g., ['nmap', 'netcat']
    documents: Array[String],          # e.g., ['attack-guide.md', 'docs/pentest.md']
    mitre_techniques: Array[String]    # e.g., ['T1003', 'T1059.001']
  }
}
```

**Bot State Structure** (existing):
```ruby
@bots[bot_name] = {
  'attacks' => [
    { 'prompt' => ..., 'context_config' => {...} },  # Attack 0
    { 'prompt' => ..., 'context_config' => {...} },  # Attack 1
    # ...
  ],
  # ... other bot fields
}
```

[Source: analysis of `bot_manager.rb` parsing methods]

### API Specifications

**XML Configuration Format**:
```xml
<attack>
  <prompt>Attack description</prompt>
  <context_config>
    <!-- Format 1: Comma-separated -->
    <man_pages>nmap,netcat,tcpdump</man_pages>
    <documents>attack-guide.md,docs/pentest.md</documents>
    <mitre_techniques>T1003,T1059.001</mitre_techniques>
    
    <!-- Format 2: Individual elements -->
    <man_pages>
      <page>nmap</page>
      <page>netcat</page>
    </man_pages>
    <documents>
      <doc>attack-guide.md</doc>
      <doc>docs/pentest.md</doc>
    </documents>
    <mitre_techniques>
      <technique>T1003</technique>
      <technique>T1059.001</technique>
    </mitre_techniques>
  </context_config>
</attack>
```

**Parser Location**: XML parsing happens in `bot_manager.rb`, likely in a method like `parse_attacks` or during bot initialization. Need to locate exact parsing code.

[Source: `docs/stories/epic-3-stage-aware-context-injection.md`]

### Component Specifications

**XML Parser**: Project uses `nokogiri` and `nori` for XML parsing (from Gemfile and code analysis)
- `nokogiri`: XML parsing library
- `nori`: XML to Ruby hash conversion

**Parsing Pattern** (from existing XML parsing):
```ruby
# Typical pattern in bot_manager.rb
doc = Nokogiri::XML(File.read(config_file))
attacks_node = doc.xpath('//attacks/attack')
attacks_node.each do |attack_node|
  attack = {
    'prompt' => attack_node.xpath('prompt').text,
    # ... parse other fields
  }
  # Add context_config parsing here
end
```

[Source: code analysis of XML parsing in bot_manager.rb]

### File Locations

**Files to Modify**:
- `bot_manager.rb` - Add context_config parsing in attack parsing method (locate `parse_attacks` or similar)
- `config/teaching_assistant_bot.xml` - Add example context_config usage
- `config/example_stage_aware_context.xml` - Create or update with comprehensive examples

**Files to Create**:
- `test/test_xml_context_config.rb` - Unit tests for XML context config parsing

**Optional Schema File** (if project uses XSD validation):
- `hackerbot_schema.xsd` - Update schema to include context_config element definition

[Source: `docs/architecture/source-tree.md`]

### Testing Requirements

**Test Framework**: Minitest
**Test Location**: `test/test_xml_context_config.rb`

**Test Fixtures**:
- Create XML files in `test/fixtures/` with various context_config formats
- Test both valid and edge case configurations
- Test backward compatibility with existing configs

**Test Patterns** (from existing tests):
```ruby
require 'minitest/autorun'
require_relative 'test_helper'
require_relative '../bot_manager.rb'
# ... test implementation
```

**Test Requirements**:
- Test all XML format variations (comma-separated, individual elements)
- Test missing/empty context_config (should not break)
- Test parsing results match expected hash structure
- Test backward compatibility with existing configs
- Verify context_config accessible in bot state

[Source: `docs/architecture/coding-standards.md`, analysis of existing test patterns]

### Technical Constraints

**XML Parsing Libraries**: 
- `nokogiri` for XML parsing
- `nori` for XML to Ruby hash conversion (may be used, verify in codebase)

**Backward Compatibility**:
- MUST NOT break existing bot configurations
- Existing attacks without context_config must work unchanged
- Optional elements should be truly optional (graceful handling)

**Performance Considerations**:
- Parsing happens once during bot initialization
- No significant performance impact expected
- Context config storage is lightweight (arrays of strings)

[Source: `docs/architecture.md`, Gemfile analysis]

### Technical Implementation Details

**Parsing Strategy**:
1. Check if `<context_config>` element exists in attack node
2. If exists, parse sub-elements:
   - `<man_pages>`: Parse text or <page> children
   - `<documents>`: Parse text or <doc> children
   - `<mitre_techniques>`: Parse text or <technique> children
3. Normalize to arrays (split comma-separated, collect individual elements)
4. Store in attack hash as `context_config` key

**Parsing Pattern for Dual Format Support**:
```ruby
# Pseudo-code for parsing man_pages
man_pages_node = attack_node.xpath('context_config/man_pages').first
if man_pages_node
  if man_pages_node.children.any? { |c| c.element? && c.name == 'page' }
    # Individual <page> elements
    man_pages = man_pages_node.xpath('page').map(&:text).map(&:strip).reject(&:empty?)
  else
    # Comma-separated text
    man_pages = man_pages_node.text.split(',').map(&:strip).reject(&:empty?)
  end
else
  man_pages = []  # Not specified
end
```

[Source: epic description, XML parsing best practices]

### Error Handling

**Parsing Errors**:
- Invalid XML structure: Log warning, skip context_config, continue parsing
- Invalid format: Log warning, attempt to parse what's possible
- Missing elements: Treat as empty array (not an error)
- Empty values: Normalize to empty arrays

**Validation Warnings**:
- Invalid MITRE technique IDs: Log warning but include in array (validation happens during retrieval)
- Non-existent file paths: Log warning but include in array (validation happens during retrieval)
- Duplicate entries: Deduplicate with warning

[Source: error handling patterns in existing codebase]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-01-XX | 2.0 | Implementation completed - All tasks and tests implemented | Dev (James) |

---

## Dev Agent Record

### Agent Model Used

Composer (Cursor AI)

### Debug Log References

N/A - No debug log entries required

### Completion Notes List

1. **Implemented parse_context_config method** in `bot_manager.rb` that supports both comma-separated and individual element formats for all three sub-elements (man_pages, documents, mitre_techniques)
2. **Integrated context_config parsing** into attack parsing loop in `read_bots` method
3. **Added validation** with non-blocking warnings for:
   - Duplicate entries (automatically deduplicated)
   - Invalid MITRE technique ID formats (T#### or T####.###)
   - Suspicious document paths (root directory or parent directory references)
4. **Created comprehensive test suite** (`test/test_xml_context_config.rb`) covering:
   - All format variations (comma-separated and individual elements)
   - Edge cases (empty, missing, whitespace, duplicates)
   - Backward compatibility
   - Multiple attacks with different configurations
5. **Added configuration examples**:
   - Updated `config/teaching_assistant_bot.xml` with example context_config
   - Created `config/example_stage_aware_context.xml` with progressive learning examples
6. **Maintained backward compatibility**: Existing configs without context_config work unchanged (returns nil when missing/empty)

### File List

**Modified Files:**
- `bot_manager.rb` - Added `parse_context_config` method and integrated into attack parsing
- `config/teaching_assistant_bot.xml` - Added example context_config to first attack

**Created Files:**
- `test/test_xml_context_config.rb` - Comprehensive test suite for context_config parsing
- `config/example_stage_aware_context.xml` - Enhanced example config demonstrating progressive learning

---

## QA Results

### Review Date: 2025-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: ✅ **EXCELLENT** - XML configuration parsing implementation is robust and production-ready.

The `parse_context_config` method in `bot_manager.rb` is well-implemented with:
- Support for both comma-separated and individual element formats for all three sub-elements
- Proper validation with non-blocking warnings (duplicates, invalid MITRE IDs, suspicious paths)
- Backward compatibility maintained (missing/empty context_config returns nil)
- Integration into `read_bots` parsing loop at correct location
- Clean storage in bot state: `@bots[bot_name]['attacks'][index]['context_config']`

**Code Strengths**:
1. **Flexible Parsing**: Supports both XML formats (comma-separated and individual elements) as specified
2. **Validation**: Non-blocking validation with helpful warnings for invalid configurations
3. **Backward Compatibility**: Existing configs without context_config work unchanged
4. **Error Handling**: Handles empty, self-closing, and missing elements gracefully
5. **Deduplication**: Automatic removal of duplicate entries with debug logging

**Integration Quality**:
- ✅ Parsing integrated correctly into attack parsing loop (line 1271)
- ✅ Context config stored alongside other attack fields
- ✅ Accessible via expected path in bot state
- ✅ Existing bot configurations remain unaffected

### Refactoring Performed

None required - implementation is clean and follows existing patterns.

### Compliance Check

- ✅ **Coding Standards**: Follows Ruby and Nokogiri XML parsing patterns
- ✅ **Project Structure**: Parser method in correct location (`bot_manager.rb`)
- ✅ **Testing Strategy**: Comprehensive test suite with all format variations and edge cases
- ✅ **All ACs Met**: All 10 acceptance criteria are fully implemented and tested

### Test Coverage Assessment

**Test File**: `test/test_xml_context_config.rb`

**Coverage Highlights**:
- ✅ Comma-separated format for all three element types
- ✅ Individual element format for all three element types
- ✅ Missing context_config (backward compatibility)
- ✅ Empty context_config (various formats)
- ✅ Whitespace handling and trimming
- ✅ Duplicate entry handling
- ✅ Mixed formats in same config
- ✅ Multiple attacks with different configurations
- ✅ Context config storage accessibility
- ✅ Backward compatibility with existing configs

**Test Quality**: Excellent - comprehensive coverage of all acceptance criteria and edge cases.

### Configuration Examples Review

✅ **Examples provided**:
- `config/teaching_assistant_bot.xml` - Simple example added
- `config/example_stage_aware_context.xml` - Comprehensive progressive learning example

Examples demonstrate:
- Progressive learning (basic to advanced knowledge)
- All format variations (comma-separated and individual elements)
- Multiple attack stages with different configurations
- Stage without context_config (demonstrating backward compatibility)

### Improvements Checklist

- [x] XML parsing supports both formats as specified
- [x] Validation with helpful warnings
- [x] Backward compatibility maintained
- [x] Configuration examples provided
- [x] Comprehensive test coverage
- [ ] Consider adding XSD schema validation in future (optional enhancement)

### Security Review

✅ **Security considerations addressed**:
- Document path validation warns on suspicious paths (root directory, parent directory references)
- MITRE technique ID format validation prevents invalid inputs
- No XML injection vulnerabilities (uses Nokogiri's safe parsing)
- Input sanitization through strip and reject empty operations

### Performance Considerations

✅ **Performance is acceptable**:
- Parsing happens once during bot initialization (no runtime overhead)
- Efficient XML parsing using Nokogiri
- Context config storage is lightweight (arrays of strings)
- No performance impact for bots without context_config

### Files Reviewed During Review

**Modified Files**:
- `bot_manager.rb` - Added `parse_context_config` method (line 1630) and integrated into attack parsing (line 1271)
- `config/teaching_assistant_bot.xml` - Added example context_config

**Created Files**:
- `test/test_xml_context_config.rb` - Comprehensive test suite
- `config/example_stage_aware_context.xml` - Enhanced example configuration

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.2-xml-context-config.yml`

All acceptance criteria met, robust parsing implementation, comprehensive tests, backward compatibility verified. Production-ready.

### Recommended Status

✅ **Ready for Done** - Story implementation is complete and meets all quality standards.

