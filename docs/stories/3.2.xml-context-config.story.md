# Story 3.2: XML Configuration for Explicit Knowledge Selection

**Epic**: Epic 3 - Stage-Aware Context Injection
**Story ID**: 3.2
**Priority**: Critical
**Estimated Effort**: 2-3 days
**Dependencies**: Story 3.1

---

## Status

**Draft**

---

## Story

**As a** bot trainer,
**I want** to configure explicit knowledge sources per attack stage in XML configuration,
**so that** I can precisely control which knowledge items are available at each training stage.

---

## Acceptance Criteria

1. XML schema supports optional `<context_config>` element within `<attack>` elements
2. `<man_pages>` sub-element accepts comma-separated list (e.g., "nmap,netcat,tcpdump") OR individual `<page>` elements (e.g., `<page>nmap</page><page>netcat</page>`)
3. `<documents>` sub-element accepts comma-separated list (e.g., "attack-guide.md,docs/pentest-primer.md") OR individual `<doc>` elements (e.g., `<doc>attack-guide.md</doc>`)
4. `<mitre_techniques>` sub-element accepts comma-separated list (e.g., "T1003,T1059.001") OR individual `<technique>` elements (e.g., `<technique>T1003</technique><technique>T1059.001</technique>`)
5. Configuration parser reads and stores attack-level context settings in bot state
6. Default behavior when no attack-level config specified (use existing RAG behavior unchanged)
7. Configuration examples added to existing XML config files (e.g., `config/teaching_assistant_bot.xml`)
8. XML schema validation ensures valid context configuration (no invalid elements or malformed structure)
9. Parser handles both empty `<context_config>` and missing `<context_config>` gracefully
10. Context config stored per attack in bot state: `@bots[bot_name]['attacks'][index]['context_config']`

---

## Integration Verification

- **IV1**: Verify XML parser doesn't break existing bot configurations without context_config
- **IV2**: Verify context config storage doesn't interfere with existing attack configuration (prompt, get_shell, quiz, etc.)
- **IV3**: Verify configuration examples validate correctly with XML schema
- **IV4**: Verify backward compatibility - bots without context_config work unchanged

---

## Tasks / Subtasks

### Phase 1: XML Schema Extension (AC: 1, 8)

- [ ] **Task 1.1: Update XML Configuration Parser for Context Config**
  - [ ] Locate XML parsing code in `bot_manager.rb` (search for `parse_attacks` or attack parsing)
  - [ ] Find method that parses `<attack>` elements (likely in `parse_attacks` or similar)
  - [ ] Add parsing logic for optional `<context_config>` element
  - [ ] Store context_config in attack hash alongside existing attack fields (prompt, get_shell, etc.)
  - [ ] Ensure parsing is optional (doesn't fail if context_config missing)

- [ ] **Task 1.2: Implement Parsing for Man Pages Element**
  - [ ] Parse `<man_pages>` element with two formats:
    - Comma-separated: `<man_pages>nmap,netcat,tcpdump</man_pages>`
    - Individual elements: `<man_pages><page>nmap</page><page>netcat</page></man_pages>`
  - [ ] Normalize to array format: `['nmap', 'netcat', 'tcpdump']`
  - [ ] Handle empty `<man_pages>` element (empty array)
  - [ ] Handle missing `<man_pages>` element (nil or empty array)

- [ ] **Task 1.3: Implement Parsing for Documents Element**
  - [ ] Parse `<documents>` element with two formats:
    - Comma-separated: `<documents>attack-guide.md,docs/pentest.md</documents>`
    - Individual elements: `<documents><doc>attack-guide.md</doc><doc>docs/pentest.md</doc></documents>`
  - [ ] Normalize to array format: `['attack-guide.md', 'docs/pentest.md']`
  - [ ] Handle empty `<documents>` element (empty array)
  - [ ] Handle missing `<documents>` element (nil or empty array)

- [ ] **Task 1.4: Implement Parsing for MITRE Techniques Element**
  - [ ] Parse `<mitre_techniques>` element with two formats:
    - Comma-separated: `<mitre_techniques>T1003,T1059.001</mitre_techniques>`
    - Individual elements: `<mitre_techniques><technique>T1003</technique><technique>T1059.001</technique></mitre_techniques>`
  - [ ] Normalize to array format: `['T1003', 'T1059.001']`
  - [ ] Handle empty `<mitre_techniques>` element (empty array)
  - [ ] Handle missing `<mitre_techniques>` element (nil or empty array)

- [ ] **Task 1.5: Store Context Config in Bot State**
  - [ ] Store parsed context_config in attack hash structure:
    ```ruby
    attack['context_config'] = {
      man_pages: ['nmap', 'netcat'],
      documents: ['attack-guide.md'],
      mitre_techniques: ['T1003', 'T1059.001']
    }
    ```
  - [ ] Ensure context_config is stored alongside existing attack fields
  - [ ] Verify accessible via: `@bots[bot_name]['attacks'][attack_index]['context_config']`

### Phase 2: Backward Compatibility (AC: 6, 9)

- [ ] **Task 2.1: Ensure Default Behavior Preserved**
  - [ ] Verify when `<context_config>` missing, attack uses existing RAG behavior
  - [ ] Verify when `<context_config>` empty, attack uses existing RAG behavior
  - [ ] Verify when all sub-elements empty, attack uses existing RAG behavior
  - [ ] Test existing bots without context_config still work correctly

- [ ] **Task 2.2: Handle Edge Cases in Parsing**
  - [ ] Handle `<context_config></context_config>` (empty element)
  - [ ] Handle `<context_config/>` (self-closing empty element)
  - [ ] Handle whitespace-only values (trim whitespace)
  - [ ] Handle duplicate values (deduplicate arrays)

### Phase 3: Configuration Examples (AC: 7)

- [ ] **Task 3.1: Add Example to Teaching Assistant Bot Config**
  - [ ] Open `config/teaching_assistant_bot.xml`
  - [ ] Add `<context_config>` example to one attack element
  - [ ] Demonstrate comma-separated format for man pages
  - [ ] Demonstrate individual element format for documents
  - [ ] Demonstrate MITRE techniques configuration
  - [ ] Verify example validates and parses correctly

- [ ] **Task 3.2: Create Enhanced Example Config File**
  - [ ] Create or update `config/example_stage_aware_context.xml`
  - [ ] Include multiple attacks with different context_config patterns
  - [ ] Show progression: early attacks with basic knowledge, later attacks with advanced knowledge
  - [ ] Include comments explaining context_config usage

### Phase 4: Validation and Error Handling (AC: 8, 9)

- [ ] **Task 4.1: Add XML Schema Validation**
  - [ ] Verify context_config elements follow correct XML structure
  - [ ] Validate that man_pages contains only text or <page> elements
  - [ ] Validate that documents contains only text or <doc> elements
  - [ ] Validate that mitre_techniques contains only text or <technique> elements
  - [ ] Log warnings for invalid structures (don't fail parsing)

- [ ] **Task 4.2: Add Configuration Validation**
  - [ ] Validate technique IDs match MITRE ATT&CK format (T#### or T####.###)
  - [ ] Log warnings for invalid technique IDs (don't fail, but warn)
  - [ ] Validate document paths are reasonable (don't fail, but log warnings)
  - [ ] Log warnings for duplicate entries in lists

### Phase 5: Testing (AC: 6, 9, 10)

- [ ] **Task 5.1: Create Test File for XML Context Config Parsing**
  - [ ] Create `test/test_xml_context_config.rb`
  - [ ] Set up test framework using Minitest
  - [ ] Create test fixtures with XML configs containing context_config

- [ ] **Task 5.2: Test Context Config Parsing**
  - [ ] Test parsing of comma-separated man_pages
  - [ ] Test parsing of individual <page> elements
  - [ ] Test parsing of comma-separated documents
  - [ ] Test parsing of individual <doc> elements
  - [ ] Test parsing of comma-separated MITRE techniques
  - [ ] Test parsing of individual <technique> elements
  - [ ] Test missing context_config (should not fail)
  - [ ] Test empty context_config (should not fail)
  - [ ] Test mixed formats (some comma-separated, some individual elements)

- [ ] **Task 5.3: Test Backward Compatibility**
  - [ ] Test existing XML configs without context_config still parse correctly
  - [ ] Test existing XML configs with context_config work correctly
  - [ ] Test bots with no context_config still use existing RAG behavior

- [ ] **Task 5.4: Test Context Config Storage**
  - [ ] Verify context_config stored correctly in bot state
  - [ ] Verify context_config accessible via `@bots[bot_name]['attacks'][index]['context_config']`
  - [ ] Test multiple attacks with different context_configs

---

## Dev Notes

### Previous Story Insights

**Story 3.1**: Identifier-based lookup methods implemented in:
- `ManPageKnowledgeSource.get_man_page_by_name(command_name, section: nil)`
- `MarkdownKnowledgeSource.get_document_by_path(file_path)`
- `MITREAttackKnowledge.get_technique_by_id(technique_id)`

These methods return RAG document format compatible with existing system. Context config parsing will reference these methods by identifier.

### Data Models

**Attack Configuration Structure** (existing in bot_manager.rb):
```ruby
attack = {
  'prompt' => String,
  'get_shell' => String,
  'quiz' => { ... },
  'system_prompt' => String,  # Optional
  # New addition:
  'context_config' => {
    man_pages: Array[String],          # e.g., ['nmap', 'netcat']
    documents: Array[String],          # e.g., ['attack-guide.md', 'docs/pentest.md']
    mitre_techniques: Array[String]    # e.g., ['T1003', 'T1059.001']
  }
}
```

**Bot State Structure** (existing):
```ruby
@bots[bot_name] = {
  'attacks' => [
    { 'prompt' => ..., 'context_config' => {...} },  # Attack 0
    { 'prompt' => ..., 'context_config' => {...} },  # Attack 1
    # ...
  ],
  # ... other bot fields
}
```

[Source: analysis of `bot_manager.rb` parsing methods]

### API Specifications

**XML Configuration Format**:
```xml
<attack>
  <prompt>Attack description</prompt>
  <context_config>
    <!-- Format 1: Comma-separated -->
    <man_pages>nmap,netcat,tcpdump</man_pages>
    <documents>attack-guide.md,docs/pentest.md</documents>
    <mitre_techniques>T1003,T1059.001</mitre_techniques>
    
    <!-- Format 2: Individual elements -->
    <man_pages>
      <page>nmap</page>
      <page>netcat</page>
    </man_pages>
    <documents>
      <doc>attack-guide.md</doc>
      <doc>docs/pentest.md</doc>
    </documents>
    <mitre_techniques>
      <technique>T1003</technique>
      <technique>T1059.001</technique>
    </mitre_techniques>
  </context_config>
</attack>
```

**Parser Location**: XML parsing happens in `bot_manager.rb`, likely in a method like `parse_attacks` or during bot initialization. Need to locate exact parsing code.

[Source: `docs/stories/epic-3-stage-aware-context-injection.md`]

### Component Specifications

**XML Parser**: Project uses `nokogiri` and `nori` for XML parsing (from Gemfile and code analysis)
- `nokogiri`: XML parsing library
- `nori`: XML to Ruby hash conversion

**Parsing Pattern** (from existing XML parsing):
```ruby
# Typical pattern in bot_manager.rb
doc = Nokogiri::XML(File.read(config_file))
attacks_node = doc.xpath('//attacks/attack')
attacks_node.each do |attack_node|
  attack = {
    'prompt' => attack_node.xpath('prompt').text,
    # ... parse other fields
  }
  # Add context_config parsing here
end
```

[Source: code analysis of XML parsing in bot_manager.rb]

### File Locations

**Files to Modify**:
- `bot_manager.rb` - Add context_config parsing in attack parsing method (locate `parse_attacks` or similar)
- `config/teaching_assistant_bot.xml` - Add example context_config usage
- `config/example_stage_aware_context.xml` - Create or update with comprehensive examples

**Files to Create**:
- `test/test_xml_context_config.rb` - Unit tests for XML context config parsing

**Optional Schema File** (if project uses XSD validation):
- `hackerbot_schema.xsd` - Update schema to include context_config element definition

[Source: `docs/architecture/source-tree.md`]

### Testing Requirements

**Test Framework**: Minitest
**Test Location**: `test/test_xml_context_config.rb`

**Test Fixtures**:
- Create XML files in `test/fixtures/` with various context_config formats
- Test both valid and edge case configurations
- Test backward compatibility with existing configs

**Test Patterns** (from existing tests):
```ruby
require 'minitest/autorun'
require_relative 'test_helper'
require_relative '../bot_manager.rb'
# ... test implementation
```

**Test Requirements**:
- Test all XML format variations (comma-separated, individual elements)
- Test missing/empty context_config (should not break)
- Test parsing results match expected hash structure
- Test backward compatibility with existing configs
- Verify context_config accessible in bot state

[Source: `docs/architecture/coding-standards.md`, analysis of existing test patterns]

### Technical Constraints

**XML Parsing Libraries**: 
- `nokogiri` for XML parsing
- `nori` for XML to Ruby hash conversion (may be used, verify in codebase)

**Backward Compatibility**:
- MUST NOT break existing bot configurations
- Existing attacks without context_config must work unchanged
- Optional elements should be truly optional (graceful handling)

**Performance Considerations**:
- Parsing happens once during bot initialization
- No significant performance impact expected
- Context config storage is lightweight (arrays of strings)

[Source: `docs/architecture.md`, Gemfile analysis]

### Technical Implementation Details

**Parsing Strategy**:
1. Check if `<context_config>` element exists in attack node
2. If exists, parse sub-elements:
   - `<man_pages>`: Parse text or <page> children
   - `<documents>`: Parse text or <doc> children
   - `<mitre_techniques>`: Parse text or <technique> children
3. Normalize to arrays (split comma-separated, collect individual elements)
4. Store in attack hash as `context_config` key

**Parsing Pattern for Dual Format Support**:
```ruby
# Pseudo-code for parsing man_pages
man_pages_node = attack_node.xpath('context_config/man_pages').first
if man_pages_node
  if man_pages_node.children.any? { |c| c.element? && c.name == 'page' }
    # Individual <page> elements
    man_pages = man_pages_node.xpath('page').map(&:text).map(&:strip).reject(&:empty?)
  else
    # Comma-separated text
    man_pages = man_pages_node.text.split(',').map(&:strip).reject(&:empty?)
  end
else
  man_pages = []  # Not specified
end
```

[Source: epic description, XML parsing best practices]

### Error Handling

**Parsing Errors**:
- Invalid XML structure: Log warning, skip context_config, continue parsing
- Invalid format: Log warning, attempt to parse what's possible
- Missing elements: Treat as empty array (not an error)
- Empty values: Normalize to empty arrays

**Validation Warnings**:
- Invalid MITRE technique IDs: Log warning but include in array (validation happens during retrieval)
- Non-existent file paths: Log warning but include in array (validation happens during retrieval)
- Duplicate entries: Deduplicate with warning

[Source: error handling patterns in existing codebase]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used

_[To be populated by Dev Agent]_

### Debug Log References

_[To be populated by Dev Agent]_

### Completion Notes List

_[To be populated by Dev Agent]_

### File List

_[To be populated by Dev Agent]_

---

## QA Results

_[To be populated by QA Agent]_

