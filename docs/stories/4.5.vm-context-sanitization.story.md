# Story 4.5: VM Context Sanitization and Security

**Status**: Draft  
**Epic**: Epic 4: VM Context Fetching from Student Machines  
**Priority**: High  
**Estimated Effort**: 2-3 days  
**Dependencies**: Story 4.3

---

## Story

**As a** developer,  
**I want** sanitization and security measures for VM context to filter sensitive information, mask passwords, and manage context size,  
**so that** student privacy is protected and context size remains manageable when VM state is included in LLM prompts.

---

## Acceptance Criteria

1. Optional sanitization of bash history (filter commands with passwords, API keys, etc.)
2. Optional masking of sensitive patterns in command outputs (passwords, tokens, etc.)
3. File size limits with truncation for large files
4. Configurable patterns for sensitive data detection and masking
5. Logging of sanitization actions (what was filtered/masked)
6. Tests verify sanitization rules work correctly
7. Documentation on security considerations and recommended sanitization settings

---

## Tasks / Subtasks

- [ ] Create `VMContextSanitizer` class (AC: 1, 2, 4)
  - [ ] Create `vm_context_sanitizer.rb` file
  - [ ] Define configurable sensitive pattern detection
  - [ ] Implement bash history filtering logic
  - [ ] Implement command output masking logic
  - [ ] Make sanitization optional (configurable)
- [ ] Implement bash history sanitization (AC: 1)
  - [ ] Filter commands containing password patterns (e.g., `password=`, `passwd`, `--password`)
  - [ ] Filter commands containing API keys (e.g., patterns like `api_key=`, `token=`)
  - [ ] Filter commands with suspicious patterns (e.g., `export PASSWORD=`, `set SECRET=`)
  - [ ] Allow configurable pattern list
  - [ ] Log filtered commands (what was removed and why)
- [ ] Implement command output masking (AC: 2)
  - [ ] Mask password patterns in command outputs (e.g., `password=secret123` → `password=***MASKED***`)
  - [ ] Mask token patterns (e.g., `token=abc123` → `token=***MASKED***`)
  - [ ] Mask API keys and secrets
  - [ ] Allow configurable masking patterns
  - [ ] Preserve output structure while masking sensitive data
- [ ] Implement file size limits and truncation (AC: 3)
  - [ ] Set default file size limit (e.g., 10KB or 100 lines)
  - [ ] Truncate large files to limit
  - [ ] Add truncation indicator (e.g., "... (truncated after 100 lines)")
  - [ ] Make file size limit configurable per bot or globally
  - [ ] Log truncation actions
- [ ] Add configurable sanitization patterns (AC: 4)
  - [ ] Define default sensitive patterns list
  - [ ] Allow XML config to specify custom patterns
  - [ ] Support regex patterns for flexible matching
  - [ ] Allow enabling/disabling individual pattern types
- [ ] Implement sanitization logging (AC: 5)
  - [ ] Log each sanitization action using `Print.debug` or `Print.warn`
  - [ ] Log filtered bash history entries (count, not content)
  - [ ] Log masked command outputs (pattern matched, not actual value)
  - [ ] Log truncated files (file path, original size, truncated size)
  - [ ] Ensure logs don't expose sensitive information themselves
- [ ] Create unit tests for sanitization (AC: 6)
  - [ ] Test bash history filtering with various patterns
  - [ ] Test command output masking with password/token patterns
  - [ ] Test file size truncation
  - [ ] Test configurable patterns
  - [ ] Test edge cases (empty input, no matches, all filtered)
- [ ] Create integration test with VMContextManager (AC: 6)
  - [ ] Test sanitization integrated with VM context fetching
  - [ ] Integrate sanitizer into VM context fetching flow
  - [ ] Verify sanitized output format
- [ ] Add documentation (AC: 7)
  - [ ] Document security considerations in `docs/` directory
  - [ ] Document recommended sanitization settings
  - [ ] Document sensitive pattern examples
  - [ ] Add XML configuration examples for sanitization

---

## Dev Notes

### Previous Story Insights
- Story 4.3: VM context fetched and assembled into formatted string
- VM context includes: bash history, command outputs, file contents
- VM context passed to LLM prompts in Story 4.4
- Need to sanitize before including in prompts to protect privacy

### Technical Details

#### Sanitization Flow
1. Fetch VM context (bash history, commands, files)
2. Apply sanitization rules:
   - Filter bash history entries
   - Mask command outputs
   - Truncate large files
3. Log sanitization actions
4. Return sanitized VM context

#### Sensitive Pattern Detection

**Default Patterns** (configurable):
- Password patterns: `/password\s*=\s*\S+/i`, `/--password\s+\S+/i`, `/passwd\s+\S+/i`
- API keys: `/api[_-]?key\s*=\s*\S+/i`, `/token\s*=\s*\S+/i`
- Secrets: `/secret\s*=\s*\S+/i`, `/export\s+\w*(PASSWORD|SECRET|KEY)=\S+/i`
- SSH keys: `-----BEGIN.*PRIVATE KEY-----`

**Masking Patterns**:
- Replace matched sensitive values with `***MASKED***`
- Preserve structure: `password=***MASKED***` instead of removing line
- Preserve context around matches

#### File Locations

**Files to Create**:
- `vm_context_sanitizer.rb` - Sanitizer class (root directory)
- `test/test_vm_context_sanitizer.rb` - Unit tests
- `docs/security/vm-context-sanitization.md` - Documentation

**Files to Modify**:
- `bot_manager.rb` - Integrate sanitizer into VM context fetching (in `fetch_vm_context` or `assemble_vm_context`)
- `config/example_stage_aware_context.xml` - Add sanitization config examples (optional)

#### Data Models and Structures

**Sanitizer Configuration**:
```ruby
sanitizer_config = {
  enable_bash_history_filtering: true,
  enable_command_masking: true,
  enable_file_truncation: true,
  max_file_size: 10_240,  # bytes
  max_file_lines: 100,
  sensitive_patterns: [
    /password\s*=\s*\S+/i,
    /api[_-]?key\s*=\s*\S+/i,
    # ... more patterns
  ],
  masking_patterns: [
    /(password\s*=\s*)(\S+)/i,  # Group 1 is prefix, Group 2 is value to mask
    # ... more patterns
  ]
}
```

**Sanitization Result**:
```ruby
{
  sanitized_bash_history: "...",
  sanitized_commands: [...],
  sanitized_files: [...],
  sanitization_log: [
    { type: 'filtered', source: 'bash_history', count: 3 },
    { type: 'masked', source: 'command', pattern: 'password', count: 1 },
    { type: 'truncated', source: 'file', path: '/etc/passwd', original_size: 15_000, truncated_size: 10_240 }
  ]
}
```

#### API Specifications

**VMContextSanitizer Class**:
```ruby
class VMContextSanitizer
  def initialize(config = {})
    # Initialize with default or custom config
  end
  
  def sanitize_bash_history(history, limit: nil)
    # Filter sensitive commands from bash history
    # Returns sanitized history string
  end
  
  def sanitize_command_output(command, output)
    # Mask sensitive patterns in command output
    # Returns masked output string
  end
  
  def sanitize_file_content(path, content)
    # Truncate large files and apply other sanitization
    # Returns sanitized content string
  end
  
  def sanitize_vm_context(vm_context_data)
    # Sanitize complete VM context structure
    # Returns sanitized VM context with log
  end
end
```

**Integration in VM Context Fetching**:
```ruby
def fetch_vm_context(bot_name, attack_index)
  # ... fetch raw VM context ...
  
  # Sanitize if enabled
  sanitizer_config = get_sanitizer_config(bot_name)
  if sanitizer_config[:enabled]
    sanitizer = VMContextSanitizer.new(sanitizer_config)
    vm_context_data = sanitizer.sanitize_vm_context(vm_context_data)
    log_sanitization_actions(vm_context_data[:sanitization_log])
  end
  
  # Assemble sanitized VM context
  assemble_vm_context(vm_context_data)
end
```

#### Component Specifications

**Sanitization Strategy**:
1. **Bash History**: Remove entire lines matching sensitive patterns (more aggressive)
2. **Command Outputs**: Mask values within output (preserve structure)
3. **Files**: Truncate but don't filter content (files may be intentionally large)

**Logging Strategy**:
- Log actions, not sensitive content
- Log counts and patterns matched, not actual values
- Use appropriate log levels (debug for details, warn for security events)

#### File Locations Based on Project Structure

[Source: docs/architecture/source-tree.md]

- **Main class**: `vm_context_sanitizer.rb` - Root directory (follows pattern of other managers)
- **Tests**: `test/test_vm_context_sanitizer.rb` - Unit tests
- **Documentation**: `docs/security/vm-context-sanitization.md` - Security docs

#### Testing Requirements

[Source: docs/architecture/coding-standards.md#testing-standards]

**Test File Structure**:
```ruby
require 'test_helper'

class VMContextSanitizerTest < Minitest::Test
  def setup
    @sanitizer = VMContextSanitizer.new(default_config)
  end
  
  def test_bash_history_filtering
    history = "cd /home\npassword=secret123\nls -la"
    result = @sanitizer.sanitize_bash_history(history)
    assert !result.include?('password=secret123')
    assert result.include?('ls -la')
  end
  
  def test_command_output_masking
    output = "password=secret123\ntoken=abc123"
    result = @sanitizer.sanitize_command_output('test', output)
    assert result.include?('password=***MASKED***')
    assert result.include?('token=***MASKED***')
  end
  
  def test_file_truncation
    large_content = "line\n" * 200
    result = @sanitizer.sanitize_file_content('/path/to/file', large_content)
    assert result.split("\n").length <= 100
    assert result.include?('truncated')
  end
end
```

#### Technical Constraints

- **Performance**: Sanitization should not significantly slow VM context fetching
- **Regex Efficiency**: Use efficient regex patterns (avoid catastrophic backtracking)
- **Memory**: Handle large files efficiently (stream processing if needed)
- **Configurability**: Allow disabling sanitization if needed (for trusted environments)

#### Security Considerations

- **Pattern Coverage**: Cover common sensitive data patterns
- **False Positives**: Minimize false positives (don't over-filter)
- **Log Security**: Ensure logs don't expose sensitive data
- **Default Secure**: Default configuration should be secure

#### Integration Points

- **Uses**: VM context data from Story 4.3
- **Integrates With**: `fetch_vm_context` method in `bot_manager.rb`
- **Called Before**: VM context passed to prompt assembly (Story 4.4)
- **Configurable Via**: XML configuration (optional)

---

## Testing

### Testing Standards
[Source: docs/architecture/coding-standards.md#testing-standards]

- **Test File Location**: `test/test_vm_context_sanitizer.rb`
- **Test Framework**: Minitest (Ruby standard library)
- **Test Naming**: `test_*` methods describing what they test
- **Test Coverage**: All sanitization rules, edge cases, error scenarios

### Specific Test Cases

1. **Test Bash History Filtering**
   - Filter password commands
   - Filter API key commands
   - Filter export SECRET commands
   - Don't filter safe commands
   - Test with empty history
   - Test with all commands filtered

2. **Test Command Output Masking**
   - Mask password patterns
   - Mask token patterns
   - Mask API keys
   - Preserve output structure
   - Test with no matches
   - Test multiple matches in same output

3. **Test File Truncation**
   - Truncate files exceeding size limit
   - Truncate files exceeding line limit
   - Add truncation indicator
   - Don't truncate small files
   - Handle empty files
   - Handle very large files

4. **Test Configurable Patterns**
   - Use default patterns
   - Use custom patterns from config
   - Test pattern enabling/disabling
   - Test regex pattern matching
   - Test invalid patterns (error handling)

5. **Test Sanitization Logging**
   - Log filtered entries count
   - Log masked patterns count
   - Log truncated file info
   - Ensure no sensitive data in logs
   - Test log format and structure

6. **Test Integration with VM Context Fetching**
   - Sanitizer integrated into fetch flow
   - Sanitized output used in prompts
   - Error handling if sanitization fails
   - Performance impact acceptable

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

_(To be populated by development agent during implementation)_

### Agent Model Used
_(To be populated)_

### Debug Log References
_(To be populated)_

### Completion Notes List
_(To be populated)_

### File List
_(To be populated)_

---

## QA Results

_(To be populated by QA agent after story implementation review)_

