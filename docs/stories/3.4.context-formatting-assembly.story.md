# Story 3.4: Context Formatting and Assembly Enhancements

**Epic**: Epic 3 - Stage-Aware Context Injection
**Story ID**: 3.4
**Priority**: High
**Estimated Effort**: 2-3 days
**Dependencies**: Story 3.3

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** explicit knowledge items formatted clearly and organized by type,
**so that** the LLM can effectively utilize the precisely selected knowledge in its responses.

---

## Acceptance Criteria

1. Context formatting groups explicit items by type (man pages, documents, MITRE)
2. Each item includes clear source attribution (e.g., "Source: man page 'nmap'", "Source: MITRE ATT&CK T1003")
3. Format is readable and well-structured for LLM consumption
4. Option to combine explicit items with query-based similarity search (configurable)
5. Context length management respects max_context_length limits
6. Tests verify formatted context structure and completeness
7. Context formatting handles empty explicit items gracefully (no empty sections)
8. Context formatting maintains compatibility with existing assemble_prompt method
9. Formatted context includes section headers for clarity (e.g., "Explicit Knowledge Sources:", "Similarity Search Results:")
10. Option to truncate long knowledge items if needed (respect max_context_length)

---

## Integration Verification

- **IV1**: Verify formatted context integrates correctly with assemble_prompt method
- **IV2**: Verify context length management doesn't truncate critical information
- **IV3**: Verify formatted context improves LLM response quality in test scenarios
- **IV4**: Verify backward compatibility - existing RAG context formatting still works

---

## Tasks / Subtasks

### Phase 1: Context Formatting Structure (AC: 1, 2, 3, 7)

- [ ] **Task 1.1: Create Context Formatting Method**
  - [ ] Create `format_explicit_context` method in `bot_manager.rb` or separate helper module
  - [ ] Method accepts array of explicit RAG documents grouped by type
  - [ ] Group documents by source_type: 'man_page', 'markdown', 'mitre_attack'
  - [ ] Format each group with clear section header

- [ ] **Task 1.2: Format Man Pages Section**
  - [ ] Section header: "Explicit Knowledge Sources - Man Pages:"
  - [ ] For each man page document:
    - [ ] Format source attribution: "Source: man page '#{command_name}'"
    - [ ] Include man page content
    - [ ] Add separator between items
  - [ ] Handle empty man pages array (skip section)

- [ ] **Task 1.3: Format Documents Section**
  - [ ] Section header: "Explicit Knowledge Sources - Documents:"
  - [ ] For each document:
    - [ ] Format source attribution: "Source: document '#{filename}'"
    - [ ] Include document content
    - [ ] Add separator between items
  - [ ] Handle empty documents array (skip section)

- [ ] **Task 1.4: Format MITRE Techniques Section**
  - [ ] Section header: "Explicit Knowledge Sources - MITRE ATT&CK Techniques:"
  - [ ] For each MITRE technique:
    - [ ] Format source attribution: "Source: MITRE ATT&CK #{technique_id}"
    - [ ] Include technique information (name, tactic, description, mitigation)
    - [ ] Add separator between items
  - [ ] Handle empty MITRE techniques array (skip section)

- [ ] **Task 1.5: Combine All Sections**
  - [ ] Combine formatted sections with clear separators
  - [ ] Only include sections with non-empty items
  - [ ] Add overall header: "Explicit Knowledge Sources:" if any items present
  - [ ] Return formatted string ready for LLM consumption

### Phase 2: Integration with Similarity Search (AC: 4, 9)

- [ ] **Task 2.1: Add Option to Combine with Similarity Search**
  - [ ] Determine behavior configuration (per-bot or per-attack)
  - [ ] Options:
    - `explicit_only`: Use only explicit items, no similarity search
    - `explicit_first`: Use explicit items, fall back to similarity if needed
    - `combined`: Use both explicit items and similarity search results
    - `similarity_fallback`: Try similarity search if explicit items not found
  - [ ] Default: `explicit_first` (explicit preferred, similarity as fallback)

- [ ] **Task 2.2: Format Combined Context**
  - [ ] When combining explicit + similarity:
    - [ ] Section 1: "Explicit Knowledge Sources:" (formatted explicit items)
    - [ ] Separator: "---"
    - [ ] Section 2: "Similarity Search Results:" (existing RAG context)
  - [ ] When explicit only: Only explicit section
  - [ ] When similarity only (fallback): Only similarity section

- [ ] **Task 2.3: Update Enhanced Context Structure**
  - [ ] Enhanced context should indicate combination mode used
  - [ ] Store formatted sections separately for debugging/logging
  - [ ] Combine into final `combined_context` string

### Phase 3: Context Length Management (AC: 5, 10)

- [ ] **Task 3.1: Implement Context Length Tracking**
  - [ ] Track character count of formatted explicit context
  - [ ] Check against `max_context_length` limit (from RAG config)
  - [ ] If over limit, apply truncation strategies:
    - Priority: Keep source attribution, truncate content
    - Option: Truncate oldest/last items first
    - Option: Truncate longest items first
  - [ ] Log warning when truncation occurs

- [ ] **Task 3.2: Truncation Strategy for Explicit Items**
  - [ ] If explicit context exceeds limit:
    - [ ] Keep all source attributions (short, important)
    - [ ] Truncate content of individual items proportionally
    - [ ] Or remove least priority items (last in list)
  - [ ] Add truncation indicator: "[Content truncated...]"

- [ ] **Task 3.3: Balance Explicit and Similarity Context**
  - [ ] When combining explicit + similarity:
    - [ ] Allocate space proportionally (e.g., 60% explicit, 40% similarity)
    - [ ] Or prioritize explicit (use max for explicit, remainder for similarity)
  - [ ] Ensure total context doesn't exceed `max_context_length`
  - [ ] Log allocation breakdown for debugging

### Phase 4: LLM-Optimized Formatting (AC: 3)

- [ ] **Task 4.1: Improve Readability for LLM**
  - [ ] Use clear section headers with consistent formatting
  - [ ] Add blank lines between sections for readability
  - [ ] Format content with proper line breaks and structure
  - [ ] Use markdown-style formatting if appropriate (headers, lists)

- [ ] **Task 4.2: Structure MITRE Technique Formatting**
  - [ ] Format MITRE techniques with structure:
    ```
    Source: MITRE ATT&CK T1003
    
    Technique: OS Credential Dumping
    Tactic: Credential Access
    Description: [description]
    Related Tools: [tools]
    Mitigation: [mitigation]
    ```
  - [ ] Make technique information easy to parse for LLM

- [ ] **Task 4.3: Structure Man Page Formatting**
  - [ ] Format man pages maintaining structure:
    ```
    Source: man page 'nmap'
    
    [man page content with preserved structure]
    ```
  - [ ] Preserve important man page sections (SYNOPSIS, DESCRIPTION, OPTIONS)

- [ ] **Task 4.4: Structure Document Formatting**
  - [ ] Format markdown documents preserving structure:
    ```
    Source: document 'attack-guide.md'
    
    [document content with markdown formatting preserved]
    ```
  - [ ] Preserve headings, lists, code blocks from markdown

### Phase 5: Integration Testing (AC: 6, 8)

- [ ] **Task 5.1: Test Context Formatting Structure**
  - [ ] Test formatting with all three types (man pages, documents, MITRE)
  - [ ] Test formatting with single type only
  - [ ] Test formatting with empty arrays (no empty sections)
  - [ ] Verify source attribution present for all items
  - [ ] Verify section headers formatted correctly

- [ ] **Task 5.2: Test Combined Context**
  - [ ] Test explicit + similarity combination
  - [ ] Test explicit only mode
  - [ ] Test similarity fallback mode
  - [ ] Verify section separators and headers

- [ ] **Task 5.3: Test Context Length Management**
  - [ ] Test with small context (under limit)
  - [ ] Test with large context (over limit, truncation)
  - [ ] Test truncation preserves source attributions
  - [ ] Test proportional allocation for combined mode
  - [ ] Verify warnings logged when truncation occurs

- [ ] **Task 5.4: Test Integration with assemble_prompt**
  - [ ] Test formatted context passed to assemble_prompt correctly
  - [ ] Test assemble_prompt incorporates formatted context properly
  - [ ] Test final prompt structure with formatted context
  - [ ] Verify backward compatibility with existing prompt assembly

- [ ] **Task 5.5: End-to-End Integration Test**
  - [ ] Test full flow: XML config → retrieval → formatting → prompt assembly → LLM response
  - [ ] Verify LLM receives well-formatted context
  - [ ] Test response quality improvement with explicit knowledge
  - [ ] Compare responses with vs without explicit formatting

---

## Dev Notes

### Previous Story Insights

**Story 3.1**: Lookup methods return RAG documents with structure:
```ruby
{
  content: String,
  metadata: {
    source: String,
    source_type: String,  # 'man_page', 'markdown', 'mitre_attack'
    # ... other metadata
  }
}
```

**Story 3.2**: Context config structure available:
```ruby
context_config = {
  man_pages: Array[String],
  documents: Array[String],
  mitre_techniques: Array[String]
}
```

**Story 3.3**: Explicit knowledge retrieval implemented in `get_enhanced_context`, returns array of RAG documents grouped by type.

### Data Models

**Formatted Context Structure**:
```ruby
formatted_context = {
  explicit_section: String,      # Formatted explicit knowledge
  similarity_section: String,     # Formatted similarity search results
  combined_context: String,      # Combined formatted context
  sections_present: Array[String],  # Which sections present
  length: Integer              # Character count
}
```

**Enhanced Context Structure** (from Story 3.3):
```ruby
enhanced_context = {
  original_query: String,
  explicit_context: Array[Hash],  # RAG documents
  explicit_sources: Array[String],
  rag_context: Hash,              # Existing similarity search
  combined_context: String,       # Final combined formatted context
  has_explicit: Boolean
}
```

[Source: Story 3.3, epic description]

### API Specifications

**Context Formatting Method**:
```ruby
def format_explicit_context(explicit_documents, options = {})
  # Group documents by type
  # Format each group with headers and source attribution
  # Combine into formatted string
  # Return formatted context
end
```

**Options**:
- `max_length`: Maximum character length (default from RAG config)
- `combine_mode`: How to combine with similarity search
- `truncation_strategy`: How to truncate if over limit

[Source: epic requirements]

### Component Specifications

**Formatting Location**:
- Option 1: Add method to `bot_manager.rb` as private helper
- Option 2: Create separate formatting helper module (e.g., `context_formatter.rb`)
- Recommendation: Start with method in `bot_manager.rb`, extract to module if needed

**Integration Points**:
- Called from `get_enhanced_context` after explicit items retrieved
- Result incorporated into `enhanced_context[:combined_context]`
- Passed to `assemble_prompt` method

[Source: `docs/architecture/source-tree.md`]

### File Locations

**Files to Modify**:
- `bot_manager.rb` - Add context formatting method and integration
- Optionally: Create `lib/context_formatter.rb` if formatting logic becomes complex

**Files to Create**:
- `test/test_context_formatting.rb` - Unit tests for context formatting

[Source: `docs/architecture/source-tree.md`]

### Testing Requirements

**Test Framework**: Minitest
**Test Location**: `test/test_context_formatting.rb`

**Test Patterns**:
```ruby
require 'minitest/autorun'
require_relative 'test_helper'
require_relative '../bot_manager.rb'
# ... test implementation
```

**Test Requirements**:
- Test formatting with various document combinations
- Test source attribution for all item types
- Test section headers and structure
- Test empty arrays handling
- Test context length management and truncation
- Test combination modes (explicit_only, combined, etc.)

[Source: `docs/architecture/coding-standards.md`]

### Technical Constraints

**Max Context Length**:
- From RAG config: `max_context_length` (default 2000-4000 characters, verify actual value)
- Must respect LLM token limits (context length correlates with token count)
- Need to balance explicit context vs similarity search results

**Performance Considerations**:
- Formatting should be fast (string operations, no external calls)
- Truncation should be efficient (don't process unnecessarily long content)

**Backward Compatibility**:
- Existing RAG context formatting must still work
- Formatting enhancements should not break existing prompt assembly
- Must handle cases where explicit context not present (fallback to existing format)

[Source: `docs/architecture.md`, RAG config analysis]

### Technical Implementation Details

**Formatting Structure**:
```
Explicit Knowledge Sources:

--- Man Pages ---
Source: man page 'nmap'
[nmap content]

Source: man page 'netcat'
[netcat content]

--- Documents ---
Source: document 'attack-guide.md'
[document content]

--- MITRE ATT&CK Techniques ---
Source: MITRE ATT&CK T1003
Technique: OS Credential Dumping
Tactic: Credential Access
Description: [description]
[... other fields]

---
Similarity Search Results:
[existing RAG context]
```

**Truncation Strategy**:
- Calculate total length of formatted context
- If over limit:
  1. Keep all source attributions (small, important)
  2. Truncate content of items proportionally
  3. Or remove items starting from end of list
  4. Add "[Content truncated...]" indicator
- Log truncation details for debugging

**Combination Modes**:
- `explicit_only`: Use only explicit context, ignore similarity
- `explicit_first`: Try explicit, fall back to similarity if empty
- `combined`: Use both, allocate space proportionally
- `similarity_fallback`: Use similarity if explicit not available

[Source: epic description, requirements analysis]

### Error Handling

**Formatting Errors**:
- Missing metadata: Use defaults, log warning
- Invalid content: Skip item, log warning, continue with others
- Formatting failure: Use simple format, log error, don't crash

**Length Management Errors**:
- Invalid max_length: Use default, log warning
- Truncation failure: Keep original, log error
- Must never crash - always return some formatted context

**Integration Errors**:
- assemble_prompt errors: Log error, use existing format, don't break prompt assembly
- Must maintain backward compatibility

[Source: error handling patterns in existing codebase]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used

_[To be populated by Dev Agent]_

### Debug Log References

_[To be populated by Dev Agent]_

### Completion Notes List

_[To be populated by Dev Agent]_

### File List

_[To be populated by Dev Agent]_

---

## QA Results

_[To be populated by QA Agent]_

