# Story 4.2: XML Configuration for VM Context Sources

**Status**: Ready for Review  
**Epic**: Epic 4: VM Context Fetching from Student Machines  
**Priority**: Critical  
**Estimated Effort**: 2-3 days  
**Dependencies**: Story 4.1

---

## Story

**As a** developer,  
**I want** XML configuration support for attack-level VM context configuration with bash history, commands, and files elements,  
**so that** I can specify what VM context to fetch from student machines per attack stage.

---

## Acceptance Criteria

1. XML schema supports optional `<vm_context>` within `<attack>` elements
2. `<bash_history>` element supports attributes: `path` (default: `~/.bash_history`), `limit` (number of lines), `user` (username)
3. `<commands>` element contains individual `<command>` elements (e.g., `<command>ps aux</command>`)
4. `<files>` element contains individual `<file>` elements with `path` attribute (e.g., `<file path="/etc/passwd"/><file path="./config.txt"/>`)
5. Configuration parser reads and stores attack-level VM context settings in bot state
6. Default behavior when no attack-level VM context config specified (no VM context fetched)
7. Configuration examples added to existing XML config files
8. XML schema validation ensures valid VM context configuration

---

## Tasks / Subtasks

- [x] Extend `parse_context_config` method or create `parse_vm_context` method in `bot_manager.rb` (AC: 1, 5)
  - [x] Locate attack parsing code (around line 1255-1279 in bot_manager.rb)
  - [x] Add parsing for optional `<vm_context>` element within `<attack>`
  - [x] Follow existing `parse_context_config` pattern (lines 1627-1750)
  - [x] Store VM context config in attack hash: `attack_data['vm_context'] = {...}`
- [x] Implement parsing for `<bash_history>` element with attributes (AC: 2)
  - [x] Parse `path` attribute (default: `~/.bash_history`)
  - [x] Parse `limit` attribute (number, optional)
  - [x] Parse `user` attribute (string, optional)
  - [x] Store as hash: `{ path: '~/.bash_history', limit: 50, user: 'student' }`
  - [x] Handle missing element (default to nil/disabled)
- [x] Implement parsing for `<commands>` element (AC: 3)
  - [x] Parse multiple `<command>` child elements
  - [x] Extract command text from each `<command>` element
  - [x] Store as array: `['ps aux', 'netstat -tuln', 'whoami']`
  - [x] Handle empty `<commands>` element (empty array)
  - [x] Handle missing element (nil or empty array)
- [x] Implement parsing for `<files>` element (AC: 4)
  - [x] Parse multiple `<file>` child elements
  - [x] Extract `path` attribute from each `<file>` element
  - [x] Store as array: `['/etc/passwd', './config.txt']`
  - [x] Handle empty `<files>` element (empty array)
  - [x] Handle missing element (nil or empty array)
- [x] Ensure default behavior (no VM context when config missing) (AC: 6)
  - [x] Attacks without `<vm_context>` element continue to work unchanged
  - [x] Bot state doesn't include `vm_context` key if not configured
  - [x] No errors logged when VM context config is missing
- [x] Add configuration examples to XML config files (AC: 7)
  - [x] Update `config/example_stage_aware_context.xml` with VM context example
  - [x] Add example showing bash_history with attributes
  - [x] Add example showing commands configuration
  - [x] Add example showing files configuration
  - [x] Add example showing all VM context elements combined
- [x] Create or update XML schema validation (AC: 8)
  - [x] Check if `hackerbot_schema.xsd` exists and update it
  - [x] Add `<vm_context>` element definition with optional sub-elements
  - [x] Define `<bash_history>` element with attributes
  - [x] Define `<commands>` and `<command>` elements
  - [x] Define `<files>` and `<file>` elements
  - [x] Ensure schema validates existing configs still work

---

## Dev Notes

### Previous Story Insights
Story 4.1 creates the `VMContextManager` class that will consume this configuration. The config structure should match the methods in VMContextManager:
- `read_bash_history(ssh_config, user=nil, limit=nil)` - needs user and limit from config
- `execute_command(ssh_config, command)` - needs command array from config
- `read_file(ssh_config, file_path)` - needs file path array from config

### Technical Details

#### XML Parsing Pattern (from bot_manager.rb)
- **Location**: `bot_manager.rb` lines 1255-1279 (attack parsing), 1627-1750 (`parse_context_config` method)
- **Pattern**: Uses `Nokogiri::XML` with `at_xpath` for element extraction
- **Namespace Removal**: `doc.remove_namespaces!` is called before parsing (line 1222)
- **Storage**: Attack data stored in `@bots[bot_name]['attacks']` array as hash elements
- **Nori Integration**: Uses `Nori.new.parse(attack.to_s)` for hash conversion, but custom parsing for complex nested structures

**Key Code Pattern to Follow** (from `parse_context_config`):
```ruby
def parse_vm_context(attack_node)
  vm_context = {}
  
  # Check if vm_context element exists
  vm_context_node = attack_node.at_xpath('vm_context')
  return nil unless vm_context_node
  
  # Parse bash_history element
  bash_history_node = vm_context_node.at_xpath('bash_history')
  if bash_history_node
    bash_history = {
      path: bash_history_node['path'] || '~/.bash_history',
      limit: bash_history_node['limit']&.to_i,
      user: bash_history_node['user']
    }
    vm_context[:bash_history] = bash_history unless bash_history.empty?
  end
  
  # Parse commands element
  commands_node = vm_context_node.at_xpath('commands')
  if commands_node
    commands = []
    commands_node.xpath('command').each do |cmd_node|
      commands << cmd_node.text.strip unless cmd_node.text.strip.empty?
    end
    vm_context[:commands] = commands unless commands.empty?
  end
  
  # Parse files element
  files_node = vm_context_node.at_xpath('files')
  if files_node
    files = []
    files_node.xpath('file').each do |file_node|
      path = file_node['path']
      files << path if path && !path.empty?
    end
    vm_context[:files] = files unless files.empty?
  end
  
  # Return nil if vm_context is empty
  vm_context.empty? ? nil : vm_context
end
```

#### File Locations

**Files to Modify**:
- `bot_manager.rb` - Add `parse_vm_context` method and integrate into attack parsing (around line 1269-1278)
- `config/example_stage_aware_context.xml` - Add VM context configuration examples
- `hackerbot_schema.xsd` - Update XML schema if it exists

**Files to Create**:
- None (extend existing files)

#### Data Models and Structures

**VM Context Configuration Structure**:
```ruby
attack_data['vm_context'] = {
  bash_history: {
    path: '~/.bash_history',  # or custom path
    limit: 50,                # optional number
    user: 'student'           # optional username
  },
  commands: ['ps aux', 'netstat -tuln', 'whoami'],  # array of command strings
  files: ['/etc/passwd', './config.txt']             # array of file paths
}
```

**XML Configuration Format**:
```xml
<attack>
  <prompt>Attack description</prompt>
  <vm_context>
    <bash_history path="~/.bash_history" limit="50" user="student"/>
    <commands>
      <command>ps aux</command>
      <command>netstat -tuln</command>
      <command>whoami</command>
    </commands>
    <files>
      <file path="/etc/passwd"/>
      <file path="./config.txt"/>
    </files>
  </vm_context>
</attack>
```

**Bot State Structure** (existing, extended):
```ruby
@bots[bot_name]['attacks'] = [
  {
    'prompt' => '...',
    'get_shell' => '...',
    'context_config' => {...},  # From Epic 3
    'vm_context' => {...}        # New from this story
  },
  # ... more attacks
]
```

#### API Specifications

**Parser Method Signature**:
```ruby
def parse_vm_context(attack_node)
  # @param attack_node [Nokogiri::XML::Element] Attack XML node
  # @return [Hash, nil] VM context configuration hash or nil if not specified
end
```

**Integration Point** (in `read_bots` method around line 1269):
```ruby
# Parse vm_context for this attack if specified
vm_context = parse_vm_context(attack)
if vm_context
  attack_data['vm_context'] = vm_context
elsif attack_data.key?('vm_context')
  # Remove vm_context key if Nori parsed an empty element
  attack_data.delete('vm_context')
end
```

#### Component Specifications

**XML Parser**: Uses `nokogiri` and `nori` for XML parsing
- `nokogiri`: For XPath-based element extraction (`at_xpath`, `xpath`)
- `nori`: For XML to Ruby hash conversion (used for simple structures)

**Parsing Pattern** (follows `parse_context_config` from Epic 3):
- Check if element exists using `at_xpath`
- Parse attributes using hash notation: `node['attribute']`
- Parse child elements using `xpath` with iteration
- Return `nil` if element is empty or missing (optional configuration)

#### File Locations Based on Project Structure

[Source: docs/architecture/source-tree.md]

- **Main parser**: `bot_manager.rb` - Add `parse_vm_context` method near `parse_context_config` (around line 1627)
- **Integration**: `bot_manager.rb` - Modify `read_bots` method around line 1269-1278
- **Examples**: `config/example_stage_aware_context.xml` - Add VM context examples
- **Schema**: `hackerbot_schema.xsd` - Update if schema exists (optional)

#### Testing Requirements

[Source: docs/architecture/coding-standards.md#testing-standards]

**Test File**: `test/test_vm_context_config.rb` (or extend existing XML config tests)

**Test Cases**:
1. **Test bash_history parsing**
   - With all attributes (path, limit, user)
   - With default path only
   - With limit only
   - Missing element (returns nil)

2. **Test commands parsing**
   - Multiple commands
   - Single command
   - Empty commands element
   - Missing element

3. **Test files parsing**
   - Multiple file paths
   - Single file path
   - Empty files element
   - Missing element

4. **Test complete vm_context**
   - All elements present
   - Partial configuration
   - Empty vm_context element (returns nil)

5. **Test integration with attack parsing**
   - VM context stored in attack hash
   - Attacks without VM context work unchanged
   - Multiple attacks with different VM configs

6. **Test XML schema validation** (if schema exists)
   - Valid VM context configs pass
   - Invalid configs fail with clear errors
   - Existing configs without VM context still validate

#### Technical Constraints

[Source: docs/architecture/tech-stack.md]

- **XML Parsing**: Use `nokogiri` (already in Gemfile)
- **No New Dependencies**: Reuse existing XML parsing infrastructure
- **Backward Compatibility**: Existing XML configs must continue to work
- **Error Handling**: Graceful handling of missing/invalid elements

#### Security Considerations

- **Path Validation**: File paths should be validated (Story 4.5 will add sanitization)
- **Command Validation**: Commands should be from trusted sources (XML config files)
- **Input Sanitization**: Ensure XML attributes don't contain injection attacks

#### Integration Points

- **Reuses**: `parse_context_config` pattern from Epic 3 (Story 3.2)
- **Integrates With**: Attack parsing in `read_bots` method (line 1255-1279)
- **Used By**: Story 4.3 will consume this configuration to fetch VM context

---

## Testing

### Testing Standards
[Source: docs/architecture/coding-standards.md#testing-standards]

- **Test File Location**: `test/test_vm_context_config.rb` (or extend existing XML parsing tests)
- **Test Framework**: Minitest (Ruby standard library)
- **Test Naming**: `test_*` methods describing what they test
- **Mock Usage**: Create test XML strings or use Nokogiri to build test XML
- **Test Coverage**: All parsing paths must have tests

### Specific Test Cases

1. **Test bash_history Element Parsing**
   ```ruby
   def test_parse_bash_history_with_all_attributes
     xml = '<vm_context><bash_history path="~/.zsh_history" limit="100" user="admin"/></vm_context>'
     result = parse_vm_context(parse_xml(xml))
     assert_equal '~/.zsh_history', result[:bash_history][:path]
     assert_equal 100, result[:bash_history][:limit]
     assert_equal 'admin', result[:bash_history][:user]
   end
   
   def test_parse_bash_history_defaults
     xml = '<vm_context><bash_history/></vm_context>'
     result = parse_vm_context(parse_xml(xml))
     assert_equal '~/.bash_history', result[:bash_history][:path]
   end
   ```

2. **Test commands Element Parsing**
   ```ruby
   def test_parse_commands_multiple
     xml = '<vm_context><commands><command>ps aux</command><command>whoami</command></commands></vm_context>'
     result = parse_vm_context(parse_xml(xml))
     assert_equal ['ps aux', 'whoami'], result[:commands]
   end
   ```

3. **Test files Element Parsing**
   ```ruby
   def test_parse_files_with_paths
     xml = '<vm_context><files><file path="/etc/passwd"/><file path="./config.txt"/></files></vm_context>'
     result = parse_vm_context(parse_xml(xml))
     assert_equal ['/etc/passwd', './config.txt'], result[:files]
   end
   ```

4. **Test Integration with Attack Parsing**
   ```ruby
   def test_attack_with_vm_context_stores_config
     # Load test XML config with VM context
     # Verify attack_data['vm_context'] is populated
   end
   
   def test_attack_without_vm_context_works_unchanged
     # Load test XML config without VM context
     # Verify attack works normally
     # Verify no vm_context key in attack_data
   end
   ```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-01-XX | 2.0 | Implementation complete - Added VM context XML parsing with comprehensive tests | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor Composer)

### Debug Log References
No debug logs required - implementation was straightforward following existing patterns.

### Completion Notes List

1. **Implementation Complete**: Created `parse_vm_context` method in `bot_manager.rb` following the exact pattern as `parse_context_config` for consistency.
2. **Integration**: Successfully integrated VM context parsing into attack parsing workflow (lines 1279-1286).
3. **Testing**: Created comprehensive test suite (`test/test_vm_context_config.rb`) with 19 test cases covering all parsing scenarios, edge cases, and integration.
4. **Documentation**: Added 3 example attack stages to `config/example_stage_aware_context.xml` demonstrating:
   - Full VM context configuration (bash_history, commands, files)
   - Minimal configuration (bash_history only)
   - Commands-only configuration
5. **Schema**: Updated `hackerbot_schema.xsd` with complete VM context element definitions including all attributes and child elements.
6. **Backward Compatibility**: Verified that attacks without `<vm_context>` elements continue to work unchanged - no breaking changes.
7. **Test Results**: All 19 tests pass (68 assertions, 0 failures).
8. **Syntax Validation**: Ruby syntax check passed for all modified files.

### File List

**Modified Files:**
- `bot_manager.rb` - Added `parse_vm_context` method (lines 1752-1815) and integrated into attack parsing (lines 1279-1286)
- `config/example_stage_aware_context.xml` - Added 3 example attack stages demonstrating VM context configuration (stages 7-9)
- `hackerbot_schema.xsd` - Extended schema with VM context element definitions (lines 14-56)

**Created Files:**
- `test/test_vm_context_config.rb` - Comprehensive test suite with 19 test cases covering all parsing scenarios

**File Statistics:**
- Code added: ~65 lines in `bot_manager.rb`
- Tests added: ~620 lines in test file
- Examples added: ~50 lines in XML config
- Schema definitions: ~45 lines in XSD

---

## QA Results

_(To be populated by QA agent after story implementation review)_

