# Story 4.3: Implement VM Context Fetching and Assembly

**Status**: Ready for Review  
**Epic**: Epic 4: VM Context Fetching from Student Machines  
**Priority**: Critical  
**Estimated Effort**: 5-6 days  
**Dependencies**: Story 4.1, Story 4.2

---

## Story

**As a** developer,  
**I want** VM context fetching implemented in bot_manager.rb that reads attack-level VM context configuration and assembles VM state into a structured format,  
**so that** the bot can retrieve and format bash history, command outputs, and file contents from student VMs via SSH.

---

## Acceptance Criteria

1. `bot_manager.rb` reads attack-level VM context configuration from bot state
2. When bash history specified, fetch via `VMContextManager.read_bash_history()`
3. When commands specified, execute via `VMContextManager.execute_command()` for each command
4. When files specified, read via `VMContextManager.read_file()` for each file
5. VM context assembled into structured format with clear source attribution
6. VM context formatted for LLM consumption (e.g., "VM State:\nBash History:\n...\nCommand Outputs:\n...\nFiles:\n...")
7. Error handling logs warnings but continues if VM context fetching fails
8. Support for optional SSH config per attack (falls back to global `get_shell` config)
9. Integration tests verify VM context fetching during attack stages

---

## Tasks / Subtasks

- [x] Create `fetch_vm_context` method in `bot_manager.rb` (AC: 1-4)
  - [x] Accept bot_name and attack_index parameters
  - [x] Get VM context config from `@bots[bot_name]['attacks'][attack_index]['vm_context']`
  - [x] Return nil if no VM context config exists (optional feature)
  - [x] Get SSH config (per-attack or fallback to global `get_shell`)
- [x] Implement bash history fetching logic (AC: 2)
  - [x] Check if `vm_context[:bash_history]` exists
  - [x] Extract path, limit, and user from config
  - [x] Call `VMContextManager.new.read_bash_history(ssh_config, user, limit)`
  - [x] Store result in VM context structure
  - [x] Handle errors gracefully (log and continue)
- [x] Implement command execution logic (AC: 3)
  - [x] Check if `vm_context[:commands]` array exists
  - [x] Iterate through each command string
  - [x] Call `VMContextManager.new.execute_command(ssh_config, command)` for each
  - [x] Store command outputs in array with command attribution
  - [x] Handle individual command failures (continue with other commands)
- [x] Implement file reading logic (AC: 4)
  - [x] Check if `vm_context[:files]` array exists
  - [x] Iterate through each file path
  - [x] Call `VMContextManager.new.read_file(ssh_config, file_path)` for each
  - [x] Store file contents in array with file path attribution
  - [x] Handle individual file read failures (continue with other files)
- [x] Create VM context assembly method `assemble_vm_context` (AC: 5)
  - [x] Accept VM context data structure (bash history, commands, files)
  - [x] Format into structured string with clear sections
  - [x] Add source attribution for each item (which command, which file)
  - [x] Return formatted VM context string
- [x] Format VM context for LLM consumption (AC: 6)
  - [x] Create clear section headers: "VM State:", "Bash History:", "Command Outputs:", "Files:"
  - [x] Format bash history with attribution if available
  - [x] Format command outputs with command name prefix
  - [x] Format file contents with file path prefix
  - [x] Ensure format is readable and clearly structured
- [x] Implement error handling (AC: 7)
  - [x] Wrap SSH operations in begin/rescue blocks
  - [x] Log warnings using `Print.warn` for SSH failures
  - [x] Log warnings for individual command/file failures
  - [x] Return partial VM context if some operations fail
  - [x] Never crash bot if VM context fetching fails completely
- [x] Support optional per-attack SSH config (AC: 8)
  - [x] Check if attack has `get_shell` in attack hash
  - [x] Fallback to global `@bots[bot_name]['get_shell']` if attack-specific not present
  - [x] Use same SSH config for all VM context operations within an attack
- [x] Create integration test `test/test_vm_context_fetching.rb` (AC: 9)
  - [x] Mock VMContextManager to avoid actual SSH connections
  - [x] Test fetching with bash_history config
  - [x] Test fetching with commands config
  - [x] Test fetching with files config
  - [x] Test fetching with all VM context types
  - [x] Test error handling (SSH failures, file not found)
  - [x] Test per-attack SSH config vs global fallback
  - [x] Verify VM context appears correctly formatted

---

## Dev Notes

### Previous Story Insights
- Story 4.1: `VMContextManager` class provides `execute_command`, `read_file`, and `read_bash_history` methods
- Story 4.2: VM context config stored in `attack_data['vm_context']` with structure: `{ bash_history: {...}, commands: [...], files: [...] }`

### Technical Details

#### VM Context Fetching Flow
1. User sends IRC message
2. Bot identifies current attack stage
3. Check if attack has `vm_context` configuration
4. If present, fetch VM context using VMContextManager
5. Assemble fetched data into formatted string
6. Pass to context assembly system

#### Bot Manager Integration Points

**Location 1: Message Handling** (`bot_manager.rb` around line 2119)
- Current: `enhanced_context = get_enhanced_context.call(bot_name, m.message, attack_index: current_attack)`
- Add: VM context fetching before or alongside enhanced context
- VM context should be fetched when attack changes or when message received (if config requires it)

**Location 2: Context Assembly** (`bot_manager.rb` around line 2122)
- Current: `assemble_prompt.call(current_system_prompt, attack_context, chat_context, m.message, enhanced_context)`
- Modify: Add VM context parameter to `assemble_prompt` (or include in enhanced_context hash)

**SSH Config Retrieval Pattern** (from bot_manager.rb lines 2197-2201):
```ruby
# Per-attack or global get_shell
if bots_ref[bot_name]['attacks'][current].key?('get_shell')
  ssh_config = { 'get_shell' => bots_ref[bot_name]['attacks'][current]['get_shell'] }
else
  ssh_config = { 'get_shell' => bots_ref[bot_name]['get_shell'] }
end
```

#### File Locations

**Files to Modify**:
- `bot_manager.rb` - Add `fetch_vm_context` and `assemble_vm_context` methods
- `bot_manager.rb` - Modify message handling to call VM context fetching (around line 2119)
- `bot_manager.rb` - Integrate VM context into prompt assembly (modify `assemble_prompt` or create wrapper)

**Files to Create**:
- `test/test_vm_context_fetching.rb` - Integration tests for VM context fetching

#### Data Models and Structures

**VM Context Data Structure** (fetched):
```ruby
vm_context_data = {
  bash_history: {
    content: "last 50 command lines...",
    path: "~/.bash_history",
    limit: 50,
    user: "student"
  },
  commands: [
    { command: "ps aux", output: "process list..." },
    { command: "whoami", output: "student" }
  ],
  files: [
    { path: "/etc/passwd", content: "file contents..." },
    { path: "./config.txt", content: "config data..." }
  ]
}
```

**Formatted VM Context String** (for LLM):
```
VM State:
Bash History (last 50 commands from ~/.bash_history):
cd /home/student
ls -la
cat secret.txt
...

Command Outputs:
[Command: ps aux]
process list output...

[Command: whoami]
student

Files:
[File: /etc/passwd]
file contents...

[File: ./config.txt]
config data...
```

**Integration with Enhanced Context**:
VM context can be added to `enhanced_context` hash as additional field:
```ruby
enhanced_context = {
  rag_context: "...",
  explicit_context: {...},
  vm_context: "VM State:\n...",  # New field
  combined_context: "..."
}
```

#### API Specifications

**fetch_vm_context Method**:
```ruby
def fetch_vm_context(bot_name, attack_index, ssh_config_override: nil)
  # @param bot_name [String] Bot name
  # @param attack_index [Integer] Current attack index
  # @param ssh_config_override [Hash, nil] Optional SSH config override
  # @return [String, nil] Formatted VM context string or nil if no config/error
end
```

**assemble_vm_context Method**:
```ruby
def assemble_vm_context(vm_context_data)
  # @param vm_context_data [Hash] VM context data structure
  # @return [String] Formatted VM context string for LLM
end
```

#### Component Specifications

**Error Handling Pattern** (follow existing patterns):
```ruby
begin
  vm_context = fetch_vm_context(bot_name, attack_index)
rescue => e
  Print.warn "Failed to fetch VM context: #{e.message}"
  vm_context = nil  # Graceful degradation
end
```

**VMContextManager Usage**:
```ruby
vm_manager = VMContextManager.new

# Bash history
if vm_config[:bash_history]
  history = vm_manager.read_bash_history(
    ssh_config,
    vm_config[:bash_history][:user],
    vm_config[:bash_history][:limit]
  )
end

# Commands
vm_config[:commands]&.each do |cmd|
  output = vm_manager.execute_command(ssh_config, cmd)
  # Store output
end

# Files
vm_config[:files]&.each do |file_path|
  content = vm_manager.read_file(ssh_config, file_path)
  # Store content
end
```

#### File Locations Based on Project Structure

[Source: docs/architecture/source-tree.md]

- **Main implementation**: `bot_manager.rb` - Add methods for VM context fetching
- **Tests**: `test/test_vm_context_fetching.rb` - Integration tests

#### Testing Requirements

[Source: docs/architecture/coding-standards.md#testing-standards]

**Test File Structure**:
```ruby
require 'test_helper'

class VMContextFetchingTest < Minitest::Test
  def setup
    @bot_manager = BotManager.new(test_config)
    # Mock VMContextManager
  end
  
  def test_fetch_vm_context_with_bash_history
    # Test bash history fetching
  end
  
  def test_fetch_vm_context_with_commands
    # Test command execution
  end
  
  def test_fetch_vm_context_error_handling
    # Test error recovery
  end
  
  def test_assemble_vm_context_formatting
    # Test VM context formatting
  end
end
```

**Test Standards**:
- Mock `VMContextManager` to avoid actual SSH connections
- Test all VM context types (bash_history, commands, files)
- Test error scenarios (SSH failures, file not found, command errors)
- Verify formatted output structure
- Test integration with attack stage progression

#### Technical Constraints

- **No Breaking Changes**: Existing functionality must continue to work
- **Optional Feature**: VM context only fetched if configured in XML
- **Performance**: VM context fetching should not significantly delay bot responses (consider async if needed)
- **Error Recovery**: Bot must continue functioning even if VM context fetching fails

#### Security Considerations

- **SSH Security**: SSH commands executed via existing secure pattern
- **File Path Validation**: File paths from XML config (trusted source)
- **Command Security**: Commands from XML config (trusted source)
- **Error Messages**: Don't expose sensitive information in error logs

#### Integration Points

- **Uses**: `VMContextManager` from Story 4.1
- **Reads**: VM context config from Story 4.2 (`attack_data['vm_context']`)
- **Integrates With**: Message handling flow (around line 2119)
- **Passes To**: Prompt assembly system (Story 4.4 will integrate into LLM prompts)

---

## Testing

### Testing Standards
[Source: docs/architecture/coding-standards.md#testing-standards]

- **Test File Location**: `test/test_vm_context_fetching.rb`
- **Test Framework**: Minitest (Ruby standard library)
- **Test Naming**: `test_*` methods describing what they test
- **Mock Usage**: Mock `VMContextManager` to avoid actual SSH operations
- **Test Coverage**: All fetching scenarios, error cases, and formatting

### Specific Test Cases

1. **Test Bash History Fetching**
   - With all config options (path, limit, user)
   - With default options
   - With SSH failure (graceful degradation)
   - Verify formatted output structure

2. **Test Command Execution**
   - Multiple commands execution
   - Individual command failure (continue with others)
   - SSH connection failure (graceful degradation)
   - Verify command outputs are attributed correctly

3. **Test File Reading**
   - Multiple file paths
   - File not found (continue with other files)
   - SSH connection failure
   - Verify file contents are attributed with paths

4. **Test VM Context Assembly**
   - All VM context types present
   - Partial VM context (some types missing)
   - Empty VM context (all operations failed)
   - Verify formatted string structure

5. **Test Integration with Bot Manager**
   - VM context fetched during message handling
   - VM context integrated into prompt assembly
   - Attacks without VM config work unchanged
   - Error handling doesn't break bot operation

6. **Test SSH Config Handling**
   - Per-attack SSH config used when specified
   - Global SSH config fallback works
   - SSH config variable substitution works

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
Composer (Claude Sonnet)

### Debug Log References
None required - implementation completed without issues

### Completion Notes List
- Implemented `fetch_vm_context` method in `bot_manager.rb` that reads VM context config from attack data
- Added support for bash history, command execution, and file reading via VMContextManager
- Created `assemble_vm_context` method to format VM context data into structured string for LLM consumption
- Integrated VM context fetching into message handling flow (around line 2348-2360)
- Modified `assemble_prompt` method to include VM context in prompt when present
- Added comprehensive error handling with graceful degradation (log warnings, continue operation)
- Implemented per-attack SSH config support with global fallback
- Created integration test suite `test/test_vm_context_fetching.rb` with 13 test cases covering all scenarios
- All acceptance criteria met - VM context fetching fully functional and tested

### File List
- `bot_manager.rb` - Modified: Added require for VMContextManager, implemented fetch_vm_context and assemble_vm_context methods, integrated VM context fetching into message handling, updated assemble_prompt to include VM context
- `test/test_vm_context_fetching.rb` - Created: Comprehensive integration test suite with mocked VMContextManager

---

## QA Results

_(To be populated by QA agent after story implementation review)_

